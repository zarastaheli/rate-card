<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page-container admin-page">
    <div class="card admin-card">
      <div class="card-content">
        <div class="card-body">
          <div class="admin-back-row">
            <button class="button button-secondary" type="button" id="back-home">Back</button>
          </div>

          <div class="admin-header">
            <div>
              <div class="entry-title entry-title--bold">Admin</div>
              <p class="subtitle">All Input Data Captured From The Flow</p>
            </div>
            <div class="admin-header-actions">
              <a class="button button-secondary" href="/admin/download">Download Spreadsheet</a>
              <button class="button button-secondary" type="button" id="clear-sheet">Clear Sheet</button>
            </div>
          </div>

          <div class="admin-tabs">
            <button class="admin-tab is-active" type="button" data-tab="deal-tab">Deal Sizing</button>
            <button class="admin-tab" type="button" data-tab="rate-tab">Rate Card + Deal Sizing</button>
          </div>

          <div class="admin-table-wrapper" id="deal-tab">
            <table class="admin-table">
              <thead>
                {% if deal_data.groups %}
                <tr class="admin-group-row">
                  <th class="admin-group-cell admin-col-action" colspan="1"></th>
                  {% for group in deal_data.groups %}
                  <th class="admin-group-cell" colspan="{{ group.span }}">{{ group.label }}</th>
                  {% endfor %}
                </tr>
                {% endif %}
                <tr>
                  <th class="admin-col-action"></th>
                  {% for header in (deal_data.headers if deal_data is defined else []) %}
                  {% set header_text = header|string %}
                  {% set is_json = 'JSON' in header_text %}
                  {% set is_breakdown = 'Breakdown' in header_text %}
                  {% set is_wrap = is_breakdown or header_text in ['Merchant Carriers', 'Merchant Service Levels', 'Redo Carriers'] %}
                  <th class="{{ 'admin-table-total' if header == 'Total Deal Size' else '' }} {{ 'admin-col-json' if is_json else '' }} {{ 'admin-col-breakdown' if is_breakdown else '' }} {{ 'admin-col-wrap' if is_wrap else '' }}">{{ header }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% if deal_data is defined and deal_data.rows %}
                  {% for row in deal_data.rows %}
                  <tr>
                    {% set row_id = deal_data.row_ids[loop.index0] if deal_data.row_ids is defined and (deal_data.row_ids | length) > loop.index0 else '' %}
                    <td class="admin-col-action">
                      {% if row_id %}
                      <button class="admin-row-delete" type="button" data-sheet="deal" data-row-id="{{ row_id }}" aria-label="Delete row">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                          <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9z"/>
                        </svg>
                      </button>
                      {% endif %}
                    </td>
                    {% for cell in row %}
                    {% set header = deal_data.headers[loop.index0] if deal_data.headers is defined else '' %}
                    {% set header_text = header|string %}
                    {% set is_json = 'JSON' in header_text %}
                    {% set is_breakdown = 'Breakdown' in header_text %}
                    {% set is_wrap = is_breakdown or header_text in ['Merchant Carriers', 'Merchant Service Levels', 'Redo Carriers'] %}
                    <td class="{{ 'admin-table-total' if header == 'Total Deal Size' else '' }} {{ 'admin-col-json' if is_json else '' }} {{ 'admin-col-breakdown' if is_breakdown else '' }} {{ 'admin-col-wrap' if is_wrap else '' }}">
                      {% if cell is mapping and cell.href %}
                        <a class="action-link-pill" href="{{ cell.href }}" target="_blank" rel="noopener noreferrer">{{ cell.label }}</a>
                      {% else %}
                        {{ cell }}
                      {% endif %}
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{{ ((deal_data.headers | length) + 1) if deal_data is defined else 2 }}">No entries yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="admin-table-wrapper is-hidden" id="rate-tab">
            <table class="admin-table">
              <thead>
                {% if rate_data.groups %}
                <tr class="admin-group-row">
                  <th class="admin-group-cell admin-col-action" colspan="1"></th>
                  {% for group in rate_data.groups %}
                  <th class="admin-group-cell" colspan="{{ group.span }}">{{ group.label }}</th>
                  {% endfor %}
                </tr>
                {% endif %}
                <tr>
                  <th class="admin-col-action"></th>
                  {% for header in (rate_data.headers if rate_data is defined else []) %}
                  {% set header_text = header|string %}
                  {% set is_json = 'JSON' in header_text %}
                  {% set is_breakdown = 'Breakdown' in header_text %}
                  {% set is_wrap = is_breakdown or header_text in ['Merchant Carriers', 'Merchant Service Levels', 'Redo Carriers'] %}
                  <th class="{{ 'admin-table-total' if header == 'Total Deal Size' else '' }} {{ 'admin-col-json' if is_json else '' }} {{ 'admin-col-breakdown' if is_breakdown else '' }} {{ 'admin-col-wrap' if is_wrap else '' }}">{{ header }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% if rate_data is defined and rate_data.rows %}
                  {% for row in rate_data.rows %}
                  <tr>
                    {% set row_id = rate_data.row_ids[loop.index0] if rate_data.row_ids is defined and (rate_data.row_ids | length) > loop.index0 else '' %}
                    <td class="admin-col-action">
                      {% if row_id %}
                      <button class="admin-row-delete" type="button" data-sheet="rate" data-row-id="{{ row_id }}" aria-label="Delete row">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                          <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9z"/>
                        </svg>
                      </button>
                      {% endif %}
                    </td>
                    {% for cell in row %}
                    {% set header = rate_data.headers[loop.index0] if rate_data.headers is defined else '' %}
                    {% set header_text = header|string %}
                    {% set is_json = 'JSON' in header_text %}
                    {% set is_breakdown = 'Breakdown' in header_text %}
                    {% set is_wrap = is_breakdown or header_text in ['Merchant Carriers', 'Merchant Service Levels', 'Redo Carriers'] %}
                    <td class="{{ 'admin-table-total' if header == 'Total Deal Size' else '' }} {{ 'admin-col-json' if is_json else '' }} {{ 'admin-col-breakdown' if is_breakdown else '' }} {{ 'admin-col-wrap' if is_wrap else '' }}">
                      {% if cell is mapping and cell.href %}
                        <a class="action-link-pill" href="{{ cell.href }}" target="_blank" rel="noopener noreferrer">{{ cell.label }}</a>
                      {% else %}
                        {{ cell }}
                      {% endif %}
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="{{ ((rate_data.headers | length) + 1) if rate_data is defined else 2 }}">No entries yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay is-hidden" id="clear-sheet-modal">
    <div class="modal-card">
      <div class="modal-title">Are You Sure You Want To Clear This Sheet?</div>
      <div class="modal-subtitle" id="clear-sheet-name">Deal Sizing Sheet</div>
      <div class="modal-actions">
        <button class="button button-secondary" type="button" id="clear-sheet-cancel">Cancel</button>
        <button class="button button-primary" type="button" id="clear-sheet-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay is-hidden" id="delete-row-modal">
    <div class="modal-card">
      <div class="modal-title">Delete This Entry?</div>
      <div class="modal-subtitle">This action cannot be undone.</div>
      <div class="modal-actions">
        <button class="button button-secondary" type="button" id="delete-row-cancel">Cancel</button>
        <button class="button button-primary" type="button" id="delete-row-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('back-home').addEventListener('click', () => {
      window.location.href = '/';
    });
    const clearSheetBtn = document.getElementById('clear-sheet');
    const clearModal = document.getElementById('clear-sheet-modal');
    const clearModalName = document.getElementById('clear-sheet-name');
    const clearConfirm = document.getElementById('clear-sheet-confirm');
    const clearCancel = document.getElementById('clear-sheet-cancel');
    const activeTabKey = 'admin_active_tab';

    document.querySelectorAll('.admin-tab').forEach((button) => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('is-active'));
        document.querySelectorAll('.admin-table-wrapper').forEach(panel => panel.classList.add('is-hidden'));
        button.classList.add('is-active');
        const target = document.getElementById(button.dataset.tab);
        if (target) target.classList.remove('is-hidden');
        localStorage.setItem(activeTabKey, button.dataset.tab || '');
      });
    });

    const savedTab = localStorage.getItem(activeTabKey);
    if (savedTab) {
      const tabBtn = document.querySelector(`.admin-tab[data-tab="${savedTab}"]`);
      if (tabBtn) {
        tabBtn.click();
      }
    }

    function currentSheetInfo() {
      const activeTab = document.querySelector('.admin-tab.is-active');
      if (activeTab && activeTab.dataset.tab === 'rate-tab') {
        return { key: 'rate', label: 'Rate Card + Deal Sizing Sheet' };
      }
      return { key: 'deal', label: 'Deal Sizing Sheet' };
    }

    function closeClearModal() {
      clearModal.classList.add('is-hidden');
    }

    clearSheetBtn.addEventListener('click', () => {
      const sheet = currentSheetInfo();
      clearModalName.textContent = sheet.label;
      clearConfirm.dataset.sheet = sheet.key;
      clearModal.classList.remove('is-hidden');
    });

    clearCancel.addEventListener('click', closeClearModal);
    clearModal.addEventListener('click', (event) => {
      if (event.target === clearModal) {
        closeClearModal();
      }
    });

    clearConfirm.addEventListener('click', async () => {
      const sheet = clearConfirm.dataset.sheet || 'deal';
      try {
        const response = await fetch('/api/admin/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sheet })
        });
        let data = {};
        try {
          data = await response.json();
        } catch (err) {
          data = {};
        }
        if (!response.ok || data.error) {
          const message = data.error || 'Unable to clear sheet. Please try again.';
          alert(message);
          return;
        }
        closeClearModal();
        window.location.reload();
      } catch (err) {
        alert('Unable to clear sheet. Please try again.');
      }
    });

    const deleteRowModal = document.getElementById('delete-row-modal');
    const deleteRowCancel = document.getElementById('delete-row-cancel');
    const deleteRowConfirm = document.getElementById('delete-row-confirm');
    let pendingDelete = null;

    function closeDeleteModal() {
      deleteRowModal.classList.add('is-hidden');
      pendingDelete = null;
    }

    deleteRowCancel.addEventListener('click', closeDeleteModal);
    deleteRowModal.addEventListener('click', (event) => {
      if (event.target === deleteRowModal) {
        closeDeleteModal();
      }
    });

    document.querySelectorAll('.admin-row-delete').forEach((button) => {
      button.addEventListener('click', () => {
        const rowId = button.dataset.rowId;
        const sheet = button.dataset.sheet || 'deal';
        if (!rowId) return;
        pendingDelete = { rowId, sheet };
        deleteRowModal.classList.remove('is-hidden');
      });
    });

    deleteRowConfirm.addEventListener('click', async () => {
      if (!pendingDelete) return;
      const { rowId, sheet } = pendingDelete;
      try {
        const response = await fetch('/api/admin/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sheet, row_id: rowId })
        });
        let data = {};
        try {
          data = await response.json();
        } catch (err) {
          data = {};
        }
        if (!response.ok || data.error) {
          const message = data.error || 'Unable to delete row. Please try again.';
          alert(message);
          return;
        }
        closeDeleteModal();
        window.location.reload();
      } catch (err) {
        alert('Unable to delete row. Please try again.');
      }
    });
  </script>
</body>
</html>
