<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generating your rate card</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page-container">
    <div class="card card--tall">
      <div class="card-content">
        <div class="card-body">

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">1</span>
          <span class="breadcrumb-label">Raw invoice</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">2</span>
          <span class="breadcrumb-label">Normalize &amp; mapping</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">3</span>
          <span class="breadcrumb-label">Merchant pricing</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">4</span>
          <span class="breadcrumb-label">Redo carriers</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item active">
          <span class="breadcrumb-number">5</span>
          <span class="breadcrumb-label">Rate card</span>
        </div>
      </div>

      <!-- Loading Content -->
      <div class="loading-content">
        <div class="spinner"></div>

        <h1 class="loading-title">Generating Your Rate Card</h1>
        <p class="loading-subtitle">Estimated Time Remaining: <span id="eta-remaining">60s</span></p>

        <ul class="loading-steps">
          <li class="loading-step" data-step="normalize">
            <span class="loading-step-icon" aria-hidden="true"></span>
            <span class="loading-step-label">Analyzing Your Data</span>
          </li>
          <li class="loading-step" data-step="write_template">
            <span class="loading-step-icon" aria-hidden="true"></span>
            <span class="loading-step-label">Loading Dashboard Summary</span>
          </li>
          <li class="loading-step" data-step="saving">
            <span class="loading-step-icon" aria-hidden="true"></span>
            <span class="loading-step-label">Loading Carrier Breakdown</span>
          </li>
        </ul>

        <div class="loading-error" style="display:none; color:#b42318; margin-top:16px; font-weight:500;"></div>
      </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function renderProgress(progress = {}) {
      ["normalize", "write_template", "saving"].forEach((key) => {
        const step = document.querySelector(`.loading-step[data-step="${key}"]`);
        if (!step) return;
        
        const labelEl = step.querySelector(".loading-step-label");
        const val = progress[key];
        
        if (typeof val === 'string' && key === 'write_template') {
           labelEl.textContent = `Loading Summary (${val})`;
        } else {
           // Reset to original label if it was a string
           if (key === 'write_template') labelEl.textContent = "Loading Dashboard Summary";
        }

        const done = val === true;
        step.classList.toggle("is-complete", done);
        const icon = step.querySelector(".loading-step-icon");
        if (icon) {
          icon.classList.toggle("is-complete", done);
        }
      });
    }

    function showError(message) {
      stopCountdown();
      const spinner = document.querySelector('.spinner');
      const errorEl = document.querySelector('.loading-error');
      if (spinner) spinner.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = message || 'There was an error generating the rate card.';
        errorEl.style.display = 'block';
      }
    }

    let countdownSeconds = 60;
    let countdownInterval = null;

    function updateEtaDisplay() {
      const etaEl = document.getElementById('eta-remaining');
      if (!etaEl) return;
      etaEl.textContent = `${Math.max(1, Math.round(countdownSeconds))}s`;
    }

    function startCountdownLoop() {
      if (countdownInterval) return;
      updateEtaDisplay();
      countdownInterval = setInterval(() => {
        if (countdownSeconds > 0) {
          countdownSeconds = Math.max(0, countdownSeconds - 1);
          updateEtaDisplay();
        }
      }, 1000);
    }

    function updateEta(seconds) {
      // Ignore server estimates, always use fixed 60s countdown
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    async function pollStatus() {
      const token = "{{ token }}";
      try {
        const res = await fetch(`/api/status/${token}`);
        const data = await res.json();

        if (data.progress) {
          renderProgress(data.progress);
        }

        if (data.error) {
          stopCountdown();
          showError(data.error);
          return;
        }

        if (data.ready) {
          stopCountdown();
          window.location = data.redirect_url;
          return;
        }

        if (typeof data.eta_seconds_remaining === 'number') {
          updateEta(data.eta_seconds_remaining);
        }
      } catch (e) {
        console.error(e);
      }

      setTimeout(pollStatus, 800);
    }

    async function animateProgressAndRedirect(token) {
      // Animate the progress bubbles filling in sequence
      const steps = ["normalize", "write_template", "saving"];
      for (let i = 0; i < steps.length; i++) {
        const key = steps[i];
        const progress = {};
        for (let j = 0; j <= i; j++) {
          progress[steps[j]] = true;
        }
        renderProgress(progress);
        await new Promise(resolve => setTimeout(resolve, 400));
      }
      // Brief pause before redirect
      await new Promise(resolve => setTimeout(resolve, 300));
      stopCountdown();
      window.location = `/dashboard?job_id=${token}`;
    }

    async function startGeneration() {
      const token = "{{ token }}";
      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ job_id: token })
        });
        const data = await res.json();
        
        if (data.status === 'completed') {
          // Animate bubbles before redirecting
          await animateProgressAndRedirect(token);
          return;
        }
        
        if (data.error) {
          stopCountdown();
          showError(data.error);
          return;
        }
      } catch (e) {
        showError('Error during generation. Please try again.');
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      startCountdownLoop();
      startGeneration();
    });
  </script>
</body>
</html>
