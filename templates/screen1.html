<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload raw invoice</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <!-- Screen 1: Raw invoice upload -->
  <div class="page-container">
    <div class="card card--upload">
      <div class="card-content">
        <div class="card-body">
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <div class="breadcrumb-item active">
          <span class="breadcrumb-number">1</span>
          <span class="breadcrumb-label">Raw invoice</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item">
          <span class="breadcrumb-number">2</span>
          <span class="breadcrumb-label">Normalize &amp; mapping</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item">
          <span class="breadcrumb-number">3</span>
          <span class="breadcrumb-label">Merchant pricing</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item">
          <span class="breadcrumb-number">4</span>
          <span class="breadcrumb-label">Redo carriers</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item">
          <span class="breadcrumb-number">5</span>
          <span class="breadcrumb-label">Rate card</span>
        </div>
      </div>

      <!-- Header -->
      <div class="page-header">
        <h1>Upload Raw Invoice</h1>
          <p class="subtitle">Upload your carrier invoice CSV or XLSX file to begin</p>
      </div>

      <div class="detected-structure-row" id="detected-structure-row" style="display: none; margin-bottom: 16px;">
        <div class="csv-structure">
          <span class="csv-structure-label">Detected structure:</span>
          <span class="csv-structure-pill" id="structure-pill">Unknown</span>
        </div>
      </div>

      <!-- Upload Area -->
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <div class="upload-default" id="upload-default">
          <p class="upload-title">Click to upload or drag and drop</p>
          <p class="upload-subtitle">CSV or XLSX files only (max 50MB)</p>
        </div>
        <div class="upload-selected" id="upload-selected" style="display: none;">
          <div class="uploaded-header">
            <div class="uploaded-check"></div>
            <span class="uploaded-label">File uploaded</span>
          </div>
          <div class="uploaded-meta">
            <span class="uploaded-file-name" id="uploaded-file-name"></span>
            <button type="button" class="replace-file-button" id="replace-file-btn">Replace file</button>
          </div>
        </div>
        <input type="file" class="file-input" id="file-input" accept=".csv,.xlsx" />
      </div>

      <!-- Merchant Info (shown after upload) -->
      <div id="merchant-info-section" style="display: none; margin-top: 24px;">
        <div class="form-grid">
          <div class="form-field">
            <label class="field-label" for="merchant-name">Merchant name <span class="required-asterisk">*</span></label>
            <input type="text" class="text-input" id="merchant-name" placeholder="Enter merchant name" />
          </div>
          <div class="form-field" id="merchant-id-field" style="display: none;">
            <label class="field-label" for="merchant-id">Merchant ID <span class="required-asterisk">*</span></label>
            <input type="text" class="text-input" id="merchant-id" placeholder="Enter merchant ID" />
          </div>
        </div>
        <div class="form-row form-row-inline" style="margin-top: 16px;">
          <input type="checkbox" id="existing-customer" />
          <label class="field-label-inline" for="existing-customer">Existing customer</label>
        </div>
        <div class="form-field" id="annual-orders-field" style="display: none; margin-top: 16px;">
          <label class="field-label" for="annual-orders">Annual orders</label>
          <input type="number" class="text-input" id="annual-orders" placeholder="Enter annual orders" min="0" />
        </div>
        <div class="form-field" id="origin-zip-field" style="display: none; margin-top: 16px;">
          <label class="field-label" for="origin-zip">Origin ZIP <span class="required-asterisk">*</span></label>
          <input type="text" class="text-input" id="origin-zip" placeholder="Enter origin ZIP code" />
        </div>
        <div class="form-field" id="amazon-eligibility-field" style="display: none; margin-top: 12px;">
          <div class="form-row form-row-inline">
            <span class="eligibility-indicator" id="amazon-eligible-indicator">✕</span>
            <span class="field-label" id="amazon-eligible-text">Amazon Eligible</span>
          </div>
        </div>
        <div class="form-field" id="uniuni-eligibility-field" style="display: none; margin-top: 12px;">
          <div class="form-row form-row-inline">
            <span class="eligibility-indicator" id="uniuni-eligible-indicator">✕</span>
            <span class="field-label" id="uniuni-eligible-text">UniUni Eligible</span>
          </div>
        </div>
        </div>

      <!-- Footer Buttons -->
      <div class="button-row">
        <button class="button button-secondary" type="button" id="cancel-btn">Cancel</button>
        <button class="button button-primary" type="button" id="continue-btn" disabled>Continue</button>
      </div>
      </div>
    </div>
  </div>

  <script>
    // Step 1 specific logic
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadDefault = document.getElementById('upload-default');
    const uploadSelected = document.getElementById('upload-selected');
    const uploadedFileName = document.getElementById('uploaded-file-name');
    const replaceFileBtn = document.getElementById('replace-file-btn');
    const merchantInfoSection = document.getElementById('merchant-info-section');
    const merchantNameInput = document.getElementById('merchant-name');
    const merchantIdField = document.getElementById('merchant-id-field');
    const merchantIdInput = document.getElementById('merchant-id');
    const existingCustomerCheckbox = document.getElementById('existing-customer');
    const detectedStructureRow = document.getElementById('detected-structure-row');
    const structurePill = document.getElementById('structure-pill');
    const originZipField = document.getElementById('origin-zip-field');
    const originZipInput = document.getElementById('origin-zip');
    const amazonEligibilityField = document.getElementById('amazon-eligibility-field');
    const amazonEligibleIndicator = document.getElementById('amazon-eligible-indicator');
    const amazonEligibleText = document.getElementById('amazon-eligible-text');
    const uniuniEligibilityField = document.getElementById('uniuni-eligibility-field');
    const uniuniEligibleIndicator = document.getElementById('uniuni-eligible-indicator');
    const uniuniEligibleText = document.getElementById('uniuni-eligible-text');
    const annualOrdersField = document.getElementById('annual-orders-field');
    const annualOrdersInput = document.getElementById('annual-orders');
    const continueBtn = document.getElementById('continue-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    let jobId = null;
    let detectedStructure = null;

    // File upload handling
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#2563eb';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = '#d0d4dd';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#d0d4dd';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect();
      }
    });

    fileInput.addEventListener('change', handleFileSelect);

    function setStructurePill(structure) {
      if (structure === 'zone') {
        structurePill.textContent = 'Zone-based';
        structurePill.className = 'csv-structure-pill csv-structure-pill--zone';
      } else if (structure === 'zip') {
        structurePill.textContent = 'Zip-based';
        structurePill.className = 'csv-structure-pill csv-structure-pill--zip';
      } else {
        structurePill.textContent = 'Unknown';
        structurePill.className = 'csv-structure-pill csv-structure-pill--unknown';
      }
    }

    function handleFileSelect() {
      const file = fileInput.files[0];
      if (!file) return;

        const lowerName = file.name.toLowerCase();
        if (!lowerName.endsWith('.csv') && !lowerName.endsWith('.xlsx')) {
          alert('Please upload a CSV or XLSX file');
          return;
        }

      if (file.size > 50 * 1024 * 1024) {
        alert('File size must be less than 50MB');
        return;
      }

      merchantNameInput.value = '';
      merchantIdInput.value = '';
      existingCustomerCheckbox.checked = false;
      merchantIdField.style.display = 'none';
      originZipInput.value = '';
      annualOrdersInput.value = '';
      amazonEligibleIndicator.textContent = '✕';
      amazonEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
      uniuniEligibleIndicator.textContent = '✕';
      uniuniEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
      localStorage.removeItem('merchant_name');
      localStorage.removeItem('merchant_id');
      localStorage.removeItem('origin_zip');
      localStorage.removeItem('annual_orders');

      uploadedFileName.textContent = file.name;
      uploadDefault.style.display = 'none';
      uploadSelected.style.display = 'flex';
      merchantInfoSection.style.display = 'block';
      detectedStructureRow.style.display = 'flex';
      originZipField.style.display = 'block';
      annualOrdersField.style.display = 'block';

      // Upload file
      const formData = new FormData();
      formData.append('invoice', file);

      fetch('/api/upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }

        jobId = data.job_id;
        detectedStructure = data.detected_structure;
        
        // Save to localStorage
        localStorage.setItem('job_id', jobId);
        localStorage.setItem('detected_structure', detectedStructure);
        localStorage.setItem('merchant_name_suggestion', data.merchant_name_suggestion || '');
        localStorage.setItem('uploaded_file_name', file.name);

        if (data.merchant_name_suggestion) {
          merchantNameInput.value = data.merchant_name_suggestion;
        }
        amazonEligibilityField.style.display = 'none';
        uniuniEligibilityField.style.display = 'none';
        setStructurePill(detectedStructure);

        updateContinueButton();
      })
      .catch(err => {
        console.error('Upload error:', err);
        alert('Error uploading file');
        merchantInfoSection.style.display = 'none';
        detectedStructureRow.style.display = 'none';
        originZipField.style.display = 'none';
        amazonEligibilityField.style.display = 'none';
        uniuniEligibilityField.style.display = 'none';
        annualOrdersField.style.display = 'none';
      });
    }

    replaceFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      fileInput.value = '';
      uploadDefault.style.display = 'flex';
      uploadSelected.style.display = 'none';
      merchantInfoSection.style.display = 'none';
      detectedStructureRow.style.display = 'none';
      originZipField.style.display = 'none';
      amazonEligibilityField.style.display = 'none';
      uniuniEligibilityField.style.display = 'none';
      annualOrdersField.style.display = 'none';
      merchantNameInput.value = '';
      merchantIdInput.value = '';
      existingCustomerCheckbox.checked = false;
      originZipInput.value = '';
      annualOrdersInput.value = '';
      amazonEligibleIndicator.textContent = '✕';
      amazonEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
      uniuniEligibleIndicator.textContent = '✕';
      uniuniEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
      localStorage.removeItem('job_id');
      localStorage.removeItem('detected_structure');
      localStorage.removeItem('merchant_name_suggestion');
      localStorage.removeItem('merchant_name');
      localStorage.removeItem('merchant_id');
      localStorage.removeItem('origin_zip');
      localStorage.removeItem('annual_orders');
      localStorage.removeItem('uploaded_file_name');
      jobId = null;
      updateContinueButton();
    });

    existingCustomerCheckbox.addEventListener('change', () => {
      merchantIdField.style.display = existingCustomerCheckbox.checked ? 'block' : 'none';
      updateContinueButton();
    });

    function updateContinueButton() {
      let canContinue = jobId !== null && merchantNameInput.value.trim() !== '';
      
      canContinue = canContinue && originZipInput.value.trim() !== '';
      
      if (existingCustomerCheckbox.checked) {
        canContinue = canContinue && merchantIdInput.value.trim() !== '';
      }

      continueBtn.disabled = !canContinue;
    }

    merchantNameInput.addEventListener('input', updateContinueButton);
    merchantIdInput.addEventListener('input', updateContinueButton);
    originZipInput.addEventListener('input', updateContinueButton);
    annualOrdersInput.addEventListener('input', () => {
      updateContinueButton();
      originZipInput.dispatchEvent(new Event('input'));
    });

    let eligibilityTimer = null;
    originZipInput.addEventListener('input', () => {
      if (eligibilityTimer) clearTimeout(eligibilityTimer);
      eligibilityTimer = setTimeout(async () => {
        const zip = originZipInput.value.trim();
        const annualOrders = annualOrdersInput.value.trim();
        if (zip.length < 3) {
          amazonEligibilityField.style.display = 'none';
          uniuniEligibilityField.style.display = 'none';
          amazonEligibleIndicator.textContent = '✕';
          amazonEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
          uniuniEligibleIndicator.textContent = '✕';
          uniuniEligibleIndicator.classList.remove('is-eligible', 'is-ineligible');
          return;
        }
        try {
          amazonEligibilityField.style.display = 'block';
          const response = await fetch('/api/amazon-eligibility', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ origin_zip: zip, annual_orders: annualOrders })
          });
          const data = await response.json();
          if (data.error) {
            amazonEligibleIndicator.textContent = '✕';
            amazonEligibleIndicator.classList.remove('is-eligible');
            amazonEligibleIndicator.classList.add('is-ineligible');
            return;
          }
          amazonEligibleIndicator.textContent = data.eligible ? '✓' : '✕';
          amazonEligibleIndicator.classList.toggle('is-eligible', !!data.eligible);
          amazonEligibleIndicator.classList.toggle('is-ineligible', !data.eligible);
        } catch (e) {
          amazonEligibleIndicator.textContent = '✕';
          amazonEligibleIndicator.classList.remove('is-eligible');
          amazonEligibleIndicator.classList.add('is-ineligible');
        }
        try {
          uniuniEligibilityField.style.display = 'block';
          const response = await fetch('/api/uniuni-eligibility', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ origin_zip: zip, annual_orders: annualOrders })
          });
          const data = await response.json();
          if (data.error) {
            uniuniEligibleIndicator.textContent = '✕';
            uniuniEligibleIndicator.classList.remove('is-eligible');
            uniuniEligibleIndicator.classList.add('is-ineligible');
            return;
          }
          uniuniEligibleIndicator.textContent = data.eligible ? '✓' : '✕';
          uniuniEligibleIndicator.classList.toggle('is-eligible', !!data.eligible);
          uniuniEligibleIndicator.classList.toggle('is-ineligible', !data.eligible);
        } catch (e) {
          uniuniEligibleIndicator.textContent = '✕';
          uniuniEligibleIndicator.classList.remove('is-eligible');
          uniuniEligibleIndicator.classList.add('is-ineligible');
        }
      }, 300);
    });

    continueBtn.addEventListener('click', () => {
      if (continueBtn.disabled) return;

      const merchantName = merchantNameInput.value.trim();
      const merchantId = existingCustomerCheckbox.checked ? merchantIdInput.value.trim() : null;
      const originZip = originZipInput.value.trim();
      const annualOrders = annualOrdersInput.value.trim();

      // Save to localStorage
      localStorage.setItem('merchant_name', merchantName);
      if (merchantId) localStorage.setItem('merchant_id', merchantId);
      if (originZip) localStorage.setItem('origin_zip', originZip);
      if (annualOrders) localStorage.setItem('annual_orders', annualOrders);

      // Navigate to mapping step
      window.location.href = `/mapping?job_id=${jobId}`;
    });

    cancelBtn.addEventListener('click', () => {
      window.location.href = '/';
    });

    function restoreFromStorage() {
      const storedJobId = localStorage.getItem('job_id');
      if (!storedJobId) return;
      jobId = storedJobId;
      detectedStructure = localStorage.getItem('detected_structure');
      const storedMerchantName = localStorage.getItem('merchant_name');
      const storedMerchantId = localStorage.getItem('merchant_id');
      const storedOriginZip = localStorage.getItem('origin_zip');
      const storedAnnualOrders = localStorage.getItem('annual_orders');
      const storedFileName = localStorage.getItem('uploaded_file_name');

      uploadedFileName.textContent = storedFileName || 'Invoice uploaded';
      uploadDefault.style.display = 'none';
      uploadSelected.style.display = 'flex';
      merchantInfoSection.style.display = 'block';
      detectedStructureRow.style.display = 'flex';
      originZipField.style.display = 'block';
      annualOrdersField.style.display = 'block';

      if (detectedStructure) {
        setStructurePill(detectedStructure);
      }

      merchantNameInput.value = storedMerchantName || localStorage.getItem('merchant_name_suggestion') || '';
      merchantIdInput.value = storedMerchantId || '';
      existingCustomerCheckbox.checked = !!storedMerchantId;
      merchantIdField.style.display = existingCustomerCheckbox.checked ? 'block' : 'none';
      originZipInput.value = storedOriginZip || '';
      annualOrdersInput.value = storedAnnualOrders || '';

      updateContinueButton();
      if (originZipInput.value.trim()) {
        originZipInput.dispatchEvent(new Event('input'));
      }
    }

    restoreFromStorage();
  </script>
</body>
</html>
