<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate card summary</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page-container">
    <div class="card card--tall">
      <div class="card-content">
        <div class="card-body balanced-body">
      <div class="breadcrumb">
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">1</span>
          <span class="breadcrumb-label">Raw invoice</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">2</span>
          <span class="breadcrumb-label">Normalize &amp; mapping</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">3</span>
          <span class="breadcrumb-label">Merchant pricing</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">4</span>
          <span class="breadcrumb-label">Redo carriers</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item active">
          <span class="breadcrumb-number">5</span>
          <span class="breadcrumb-label">Rate card</span>
        </div>
      </div>

      <div class="dashboard-header">
        <div>
          <h1>Rate Card Summary</h1>
          <p class="subtitle">Overview and carrier breakdown based on your selections</p>
        </div>
        <div class="dashboard-actions">
          <button class="button button-primary button-no-shadow" type="button" id="download-btn">Download Rate Card</button>
          <button class="button button-secondary" type="button" id="sharepoint-btn">View File In Sharepoint</button>
        </div>
      </div>

      <div id="dashboard-loading" class="dashboard-loading">
        <div class="dashboard-loading-spinner"></div>
        <div class="dashboard-loading-text">Loading summary...</div>
      </div>

      <div id="dashboard-content" class="dashboard-content is-hidden">
      <div class="section-block selected-carriers-section">
        <div class="section-title">Redo Carriers Sold</div>
        <div class="carrier-chips" id="selected-carriers"></div>
      </div>

      <div class="dashboard-banner is-hidden" id="annual-orders-banner">
        <span>Add annual orders to see spread</span>
        <button class="button button-secondary button-compact" type="button" id="annual-orders-btn">Add annual orders</button>
      </div>

      <div class="modal-overlay is-hidden" id="annual-orders-modal">
        <div class="modal-card">
          <div class="modal-title">Add Annual Orders</div>
          <p class="modal-subtitle">Enter the annual order count to calculate savings and spread</p>
          <input type="number" class="text-input modal-input" id="annual-orders-input" placeholder="Annual orders" min="1" />
          <div class="modal-actions">
            <button class="button button-secondary" type="button" id="annual-orders-cancel">Cancel</button>
            <button class="button button-primary" type="button" id="annual-orders-save">Save</button>
          </div>
          <div class="modal-loading is-hidden" id="annual-orders-loading">
            <span class="dashboard-loading-spinner"></span>
            <span>Calculating…</span>
          </div>
        </div>
      </div>

      <div class="modal-overlay is-hidden" id="deal-sizing-modal">
        <div class="modal-card modal-card--wide">
          <div class="modal-title">Deal Sizing</div>
          <p class="modal-subtitle">Adjust inputs to refine the sizing estimate</p>

          <div class="deal-sizing-carriers">
            <div class="deal-sizing-carriers-title">Redo Carriers Sold</div>
            <div class="carrier-chips carrier-chips--compact" id="deal-sizing-carriers"></div>
          </div>

          <div class="deal-sizing-summary">
            <div class="deal-summary-card">
              <div class="deal-summary-label">Carrier Spread</div>
              <div class="deal-summary-value" id="deal-carrier-spread">$--</div>
              <div class="deal-summary-spinner is-hidden" id="deal-carrier-spread-loading">
                <span class="dashboard-loading-spinner"></span>
                <span>Calculating...</span>
              </div>
            </div>
            <div class="deal-summary-card">
              <div class="deal-summary-label">Adjusted Annual Orders</div>
              <div class="deal-summary-value" id="deal-adjusted-orders">--</div>
            </div>
            <div class="deal-summary-card">
              <div class="deal-summary-label">Attach Rate</div>
              <div class="deal-summary-input">
                <input type="number" class="text-input deal-input-filled deal-input-attach" id="deal-attach-rate" min="0" max="100" step="0.1" />
                <span class="deal-sizing-suffix">%</span>
              </div>
            </div>
          </div>

          <div class="deal-sizing-grid deal-sizing-grid--compact">
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-saas-fee">SaaS Fee</label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-saas-fee" min="0" step="0.01" />
              </div>
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-per-label-fee">Per Label Fee</label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-per-label-fee" min="0" step="0.01" />
              </div>
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-fee-order-pct">% Of Orders With Fee</label>
              <div class="deal-sizing-input">
                <input type="number" class="text-input deal-input-filled" id="deal-fee-order-pct" min="0" max="100" step="0.1" />
                <span class="deal-sizing-suffix">%</span>
              </div>
            </div>
          </div>

          <div class="deal-sizing-grid deal-sizing-grid--inputs">
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-annual-orders">Annual Orders</label>
              <input type="number" class="text-input deal-input-filled" id="deal-annual-orders" min="0" />
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-avg-label-cost">Average Label Cost</label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-avg-label-cost" min="0" step="0.01" />
              </div>
            </div>
          </div>

          <div class="deal-sizing-upload-block" id="deal-attach-upload-field">
            <div class="deal-sizing-upload-drop">
              <span class="deal-upload-icon">⬆︎</span>
              <div class="deal-sizing-upload-text">
                <strong>Upload a Screenshot of Redo Usage Dashboard</strong>
                <span>Required if attach rate is above 85%</span>
              </div>
              <input type="file" class="deal-sizing-file" id="deal-attach-upload" accept="image/*,.pdf" />
            </div>
          </div>

          <div class="deal-sizing-toggles">
            <div class="toggle-row toggle-row--flat">
              <span>CommentSold</span>
              <label class="switch">
                <input type="checkbox" id="toggle-commentsold" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="toggle-row toggle-row--flat toggle-row--stack">
              <div class="toggle-stack">
                <div class="toggle-stack-row">
                  <span>Ebay</span>
                  <label class="switch">
                    <input type="checkbox" id="toggle-ebay" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="toggle-stack-row toggle-stack-row--nested" id="toggle-live-row">
                  <span>Live Selling</span>
                  <label class="switch">
                    <input type="checkbox" id="toggle-live-selling" />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
            <div class="toggle-row toggle-row--flat">
              <span>Printing Today</span>
              <label class="switch">
                <input type="checkbox" id="toggle-printing" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="modal-actions modal-actions--spread">
            <button class="button button-secondary" type="button" id="deal-sizing-close">Close</button>
            <button class="button button-primary" type="button" id="deal-sizing-save">Save</button>
          </div>
        </div>
      </div>

      <div class="summary-grid" id="summary-grid">
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">Est. Merchant Annual Savings</div>
            <div class="metric-value" id="metric-merchant-savings">--</div>
          </div>
          <div class="metric-note">Estimate</div>
        </div>
        <div class="metric-card metric-card--deal-sizing">
          <button class="deal-sizing-edit-btn" type="button" id="deal-sizing-edit" aria-label="Expand deal size"></button>
          <div class="metric-main">
            <div class="metric-label">Est. Redo Deal Size</div>
            <div class="metric-value metric-value--deal">
              <span id="metric-redo-deal-size">--</span>
            </div>
            <button class="metric-action deal-sizing-cta" type="button" id="deal-sizing-btn">
              Click to Deal Size
            </button>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">Total Spread Avaliable</div>
            <div class="metric-value" id="metric-spread-available">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">% Orders We Could Win</div>
            <div class="metric-value" id="metric-orders-could-win">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">% Orders Won W/ Spread</div>
            <div class="metric-value" id="metric-orders-won-spread">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
      </div>

      <div class="section-block is-hidden" id="breakdown-section">
        <div class="section-title">Carrier breakdown</div>
        <div class="breakdown-table">
          <div class="breakdown-row breakdown-header">
            <div>Carrier</div>
            <div>Est. Merchant Annual Savings</div>
            <div>Est. Redo Deal Size</div>
            <div>Total Spread Avaliable</div>
            <div>% Orders We Could Win</div>
            <div>% Orders Won W/ Spread</div>
          </div>
          <div class="breakdown-loading" id="breakdown-loading">Loading carrier breakdown...</div>
          <div id="carrier-breakdown"></div>
        </div>
      </div>

      <div class="usps-discount-row is-hidden" id="usps-discount-row">
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-percent-off">% Off USPS Market Rate</label>
          <div class="usps-discount-input">
            <input type="number" class="text-input" id="usps-percent-off" min="0" step="0.1" />
            <span class="usps-discount-suffix">%</span>
          </div>
        </div>
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-dollar-off">$ Off USPS Market Rate</label>
          <div class="usps-discount-input">
            <span class="usps-discount-prefix">$</span>
            <input type="number" class="text-input" id="usps-dollar-off" min="0" step="0.01" />
          </div>
        </div>
      </div>

      <div class="dashboard-footnote dashboard-footnote--alert">All Figures Are Estimates - Final Deal Size Will Be Determined By Deal Desk</div>
      <div class="dashboard-bottom-actions">
        <button class="button button-secondary" type="button" id="back-to-redo-btn">Back</button>
        <button class="button button-secondary" type="button" id="start-over-btn">Start Over</button>
      </div>
      </div>

      </div>
      </div>
    </div>
  </div>

  <script>
    const jobId = '{{ job_id }}';
    const merchantName = '{{ merchant_name }}';
    const downloadBtn = document.getElementById('download-btn');
    const sharepointBtn = document.getElementById('sharepoint-btn');
    const backToRedoBtn = document.getElementById('back-to-redo-btn');
    const startOverBtn = document.getElementById('start-over-btn');
    const annualOrdersBanner = document.getElementById('annual-orders-banner');
    const annualOrdersBtn = document.getElementById('annual-orders-btn');
    const annualOrdersModal = document.getElementById('annual-orders-modal');
    const annualOrdersInput = document.getElementById('annual-orders-input');
    const annualOrdersCancel = document.getElementById('annual-orders-cancel');
    const annualOrdersSave = document.getElementById('annual-orders-save');
    const annualOrdersLoading = document.getElementById('annual-orders-loading');
    const uspsDiscountRow = document.getElementById('usps-discount-row');
    const uspsPercentOffInput = document.getElementById('usps-percent-off');
    const uspsDollarOffInput = document.getElementById('usps-dollar-off');
    const selectedCarriersEl = document.getElementById('selected-carriers');
    const dealSizingCarriersEl = document.getElementById('deal-sizing-carriers');
    const dealSizingBtn = document.getElementById('deal-sizing-btn');
    const dealSizingEdit = document.getElementById('deal-sizing-edit');
    const dealSizingModal = document.getElementById('deal-sizing-modal');
    const dealSizingClose = document.getElementById('deal-sizing-close');
    const dealAnnualOrders = document.getElementById('deal-annual-orders');
    const dealAvgLabelCost = document.getElementById('deal-avg-label-cost');
    const dealPerLabelFee = document.getElementById('deal-per-label-fee');
    const dealFeeOrderPct = document.getElementById('deal-fee-order-pct');
    const dealAttachRate = document.getElementById('deal-attach-rate');
    const dealAttachUploadField = document.getElementById('deal-attach-upload-field');
    const dealAttachUpload = document.getElementById('deal-attach-upload');
    const dealSaasFee = document.getElementById('deal-saas-fee');
    const dealAdjustedOrders = document.getElementById('deal-adjusted-orders');
    const toggleCommentSold = document.getElementById('toggle-commentsold');
    const toggleEbay = document.getElementById('toggle-ebay');
    const toggleLiveSelling = document.getElementById('toggle-live-selling');
    const toggleLiveRow = document.getElementById('toggle-live-row');
    const togglePrinting = document.getElementById('toggle-printing');
    const dealSizingSave = document.getElementById('deal-sizing-save');
    const dealSizingCard = document.querySelector('.metric-card--deal-sizing');
    const dealSizeStorageKey = `deal_size_value_${jobId}`;
    const dealCarrierSpreadLoading = document.getElementById('deal-carrier-spread-loading');

    downloadBtn.addEventListener('click', () => {
      window.location.href = `/download/${jobId}/rate-card`;
    });
    sharepointBtn.addEventListener('click', () => {
      window.open(`https://sharepoint.example.com?merchant=${encodeURIComponent(merchantName)}`, '_blank');
    });
    backToRedoBtn.addEventListener('click', () => {
      window.location.href = `/redo-carriers?job_id=${jobId}`;
    });
    startOverBtn.addEventListener('click', () => {
      localStorage.removeItem('job_id');
      localStorage.removeItem('detected_structure');
      localStorage.removeItem('merchant_name_suggestion');
      localStorage.removeItem('merchant_name');
      localStorage.removeItem('merchant_id');
      localStorage.removeItem('origin_zip');
      localStorage.removeItem('annual_orders');
      localStorage.removeItem('flow_type');
      localStorage.removeItem(dealSizeStorageKey);
      window.location.href = '/';
    });

    const metricMap = {
      'Est. Merchant Annual Savings': 'metric-merchant-savings',
      'Est. Redo Deal Size': 'metric-redo-deal-size',
      'Spread Available': 'metric-spread-available',
      '% Orders We Could Win': 'metric-orders-could-win',
      '% Orders Won W/ Spread': 'metric-orders-won-spread'
    };

    const suppressedMetrics = new Set([
      'Est. Merchant Annual Savings',
      'Est. Redo Deal Size',
      'Spread Available'
    ]);
    let annualOrdersMissing = false;
    let discountUpdateTimer = null;
    let currentMetrics = {};
    let dealSpreadPerOrder = 0;
    let dealCarrierDetails = [];
    let dealCarrierDetailsPending = false;

    function formatMetric(label, value) {
      if (annualOrdersMissing && suppressedMetrics.has(label)) return '--';
      if (value === null || value === undefined || value === '') return '--';
      if (typeof value === 'string') return value;
      if (label.includes('%')) {
        return `${Math.round(value * 100)}%`;
      }
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(value);
    }

    function parseMetricValue(value) {
      if (value === null || value === undefined || value === '') return null;
      if (typeof value === 'number') return value;
      const cleaned = String(value).replace(/[$,%]/g, '').replace(/,/g, '').trim();
      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function getSavedDealSize() {
      const raw = localStorage.getItem(dealSizeStorageKey);
      if (!raw) return null;
      const parsed = Number(raw);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function renderSummary(metrics) {
      currentMetrics = metrics || {};
      Object.entries(metricMap).forEach(([label, id]) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (label === 'Est. Redo Deal Size') {
          const saved = getSavedDealSize();
          el.textContent = saved !== null ? formatCurrency(saved) : '--';
          return;
        }
        el.textContent = formatMetric(label, metrics[label]);
      });
      const dealValueEl = document.getElementById('metric-redo-deal-size');
      if (dealSizingCard && dealValueEl) {
        const saved = getSavedDealSize();
        dealSizingCard.classList.toggle('has-deal-size', saved !== null);
      }
    }

    let carrierPercentages = {};

    function formatCarrierPercent(value) {
      if (!Number.isFinite(value)) return '';
      return `${Math.round(value * 100)}`;
    }

    function renderSelectedCarriers(available, selected, options = {}) {
      const containers = options.containers || [];
      const showPercent = !!options.showPercent;
      containers.forEach((container) => {
        if (container) container.innerHTML = '';
      });
      const selectedSet = new Set(selected);
      const ordered = [
        ...available.filter(carrier => selectedSet.has(carrier)),
        ...available.filter(carrier => !selectedSet.has(carrier))
      ];
      ordered.forEach((carrier) => {
        containers.forEach((container) => {
          if (!container) return;
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'carrier-chip';
          if (selectedSet.has(carrier)) {
            chip.classList.add('is-selected');
          }
          if (showPercent) {
            chip.classList.add('carrier-chip--with-percent');
            const percentText = formatCarrierPercent(carrierPercentages[carrier]);
            chip.innerHTML = `
              <span class="carrier-chip-label">${carrier}</span>
              <span class="carrier-chip-percent">${percentText}</span>
            `;
          } else {
            chip.textContent = carrier;
          }
          chip.dataset.carrier = carrier;
          container.appendChild(chip);
        });
      });
    }

    function renderCarrierBars(available, selected) {
      renderSelectedCarriers(available, selected, {
        containers: [selectedCarriersEl],
        showPercent: false
      });
      renderSelectedCarriers(available, selected, {
        containers: [dealSizingCarriersEl],
        showPercent: false
      });
    }

    function renderBreakdown(perCarrier) {
      const container = document.getElementById('carrier-breakdown');
      container.innerHTML = '';
      const columns = [
        { key: 'Est. Merchant Annual Savings', label: 'Est. Merchant Annual Savings' },
        { key: 'Est. Redo Deal Size', label: 'Est. Redo Deal Size' },
        { key: 'Spread Available', label: 'Total Spread Avaliable' },
        { key: '% Orders We Could Win', label: '% Orders We Could Win' },
        { key: '% Orders Won W/ Spread', label: '% Orders Won W/ Spread' }
      ];
      const maxValues = {};
      columns.forEach(({ key }) => {
        const values = perCarrier
          .map(row => parseMetricValue((row.metrics || {})[key]))
          .filter(val => val !== null);
        maxValues[key] = values.length ? Math.max(...values) : null;
      });
      perCarrier.forEach((row) => {
        const metrics = row.metrics || {};
        const rowEl = document.createElement('div');
        rowEl.className = 'breakdown-row';
        const formatWithHighlight = (key) => {
          if (annualOrdersMissing && suppressedMetrics.has(key)) {
            return '--';
          }
          const raw = metrics[key];
          const formatted = formatMetric(key, raw);
          const numeric = parseMetricValue(raw);
          const max = maxValues[key];
          if (numeric !== null && max !== null && numeric === max) {
            return `<span class="metric-pill">${formatted}</span>`;
          }
          return formatted;
        };
        rowEl.innerHTML = `
          <div>${row.carrier}</div>
          <div>${formatWithHighlight('Est. Merchant Annual Savings')}</div>
          <div>${formatWithHighlight('Est. Redo Deal Size')}</div>
          <div>${formatWithHighlight('Spread Available')}</div>
          <div>${formatWithHighlight('% Orders We Could Win')}</div>
          <div>${formatWithHighlight('% Orders Won W/ Spread')}</div>
        `;
        container.appendChild(rowEl);
      });
    }

    let currentSelection = [];
    let selectionTimer = null;

    function setLoading(isLoading, message, hideContent) {
      const loadingEl = document.getElementById('dashboard-loading');
      const contentEl = document.getElementById('dashboard-content');
      if (message) {
        const textEl = loadingEl.querySelector('.dashboard-loading-text');
        if (textEl) textEl.textContent = message;
      }
      loadingEl.style.display = isLoading ? 'flex' : 'none';
      contentEl.classList.toggle('is-dimmed', isLoading && !hideContent);
      if (hideContent) {
        contentEl.classList.toggle('is-hidden', isLoading);
      } else {
        contentEl.classList.remove('is-hidden');
      }
    }

    async function loadDashboard(selected = null, initial = false, recalculating = false, refresh = false) {
      if (initial) {
        setLoading(true, 'Loading summary...', true);
      } else if (recalculating) {
        setLoading(true, 'Recalculating...', false);
      }
      const options = selected
        ? {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ selected_carriers: selected })
          }
        : {};
      const refreshParam = refresh ? '?refresh=1' : '';
      const response = await fetch(`/api/dashboard/${jobId}${refreshParam}`, options);
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        setLoading(false, '', false);
        return;
      }
      if (data.summary_pending) {
        if (initial) {
          setLoading(true, 'Loading summary...', true);
        } else if (recalculating) {
          setLoading(true, 'Recalculating...', false);
        }
        setTimeout(() => loadDashboard(selected, initial, recalculating, refresh), 700);
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.summary_pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.show_usps_market_discount) {
        const pct = Number(data.usps_market_pct_off) * 100;
        uspsPercentOffInput.value = Number.isFinite(pct) ? pct.toFixed(1).replace(/\.0$/, '') : '5';
        uspsDollarOffInput.value = Number.isFinite(Number(data.usps_market_dollar_off))
          ? Number(data.usps_market_dollar_off).toFixed(2).replace(/\.00$/, '')
          : '0';
      }
      currentSelection = data.selected_carriers || [];
      carrierPercentages = data.carrier_percentages || {};
      renderSummary(data.overall || {});
      renderCarrierBars(data.available_carriers || [], currentSelection);
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) {
        breakdownSection.classList.remove('is-hidden');
      }
      setLoading(false, '', false);
    }

    async function loadPerCarrier(refresh = false) {
      const loadingEl = document.getElementById('breakdown-loading');
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) breakdownSection.classList.remove('is-hidden');
      loadingEl.style.display = 'block';
      const refreshParam = refresh ? '&refresh=1' : '';
      const response = await fetch(`/api/dashboard/${jobId}?per_carrier=1${refreshParam}`);
      const data = await response.json();
      if (data.error) {
        loadingEl.textContent = 'Unable to load carrier breakdown.';
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.per_carrier_total) {
        loadingEl.textContent = `Calculating carrier breakdown ${data.per_carrier_count || 0}/${data.per_carrier_total}...`;
      }
      if (data.per_carrier && data.per_carrier.length) {
        renderBreakdown(data.per_carrier);
      }
      if (data.pending) {
        setTimeout(() => loadPerCarrier(refresh), 900);
        return;
      }
      loadingEl.style.display = 'none';
    }

    document.addEventListener('click', (event) => {
      const chip = event.target.closest('.carrier-chip');
      if (!chip || !chip.dataset.carrier) return;
      if (selectionTimer) clearTimeout(selectionTimer);
      selectionTimer = setTimeout(() => {
        const carriers = Array.from(new Set(
          Array.from(document.querySelectorAll('.carrier-chip'))
            .map(el => el.dataset.carrier)
        ));
        const selected = Array.from(new Set(
          Array.from(document.querySelectorAll('.carrier-chip.is-selected'))
            .map(el => el.dataset.carrier)
        ));
        const target = chip.dataset.carrier;
        const nextSelected = selected.includes(target)
          ? selected.filter(c => c !== target)
          : [...selected, target];
        if (!nextSelected.length) {
          renderCarrierBars(carriers, currentSelection);
          return;
        }
        loadDashboard(nextSelected, false, true);
      }, 200);
    });

    loadDashboard(null, true).then(loadPerCarrier);

    function openAnnualOrdersModal() {
      annualOrdersModal.classList.remove('is-hidden');
      annualOrdersInput.value = '';
      annualOrdersInput.focus();
    }

    function closeAnnualOrdersModal() {
      if (!annualOrdersLoading.classList.contains('is-hidden')) return;
      annualOrdersModal.classList.add('is-hidden');
    }

    async function saveAnnualOrders() {
      const cleaned = String(annualOrdersInput.value || '').replace(/[, ]/g, '');
      if (!cleaned || isNaN(cleaned)) {
        alert('Please enter a valid number');
        return;
      }
      const value = Math.floor(Number(cleaned));
      if (value <= 0) {
        alert('Annual orders must be greater than 0');
        return;
      }
      annualOrdersLoading.classList.remove('is-hidden');
      annualOrdersSave.disabled = true;
      annualOrdersCancel.disabled = true;
      const response = await fetch(`/api/annual-orders/${jobId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ annual_orders: value })
      });
      const data = await response.json();
      annualOrdersLoading.classList.add('is-hidden');
      annualOrdersSave.disabled = false;
      annualOrdersCancel.disabled = false;
      if (data.error) {
        alert(data.error);
        return;
      }
      localStorage.setItem('annual_orders', String(value));
      closeAnnualOrdersModal();
      loadDashboard(currentSelection, false, true).then(loadPerCarrier);
    }

    annualOrdersBtn.addEventListener('click', openAnnualOrdersModal);
    annualOrdersCancel.addEventListener('click', closeAnnualOrdersModal);
    annualOrdersSave.addEventListener('click', saveAnnualOrders);
    annualOrdersModal.addEventListener('click', (event) => {
      if (event.target === annualOrdersModal) {
        closeAnnualOrdersModal();
      }
    });

    function queueDiscountUpdate() {
      if (discountUpdateTimer) clearTimeout(discountUpdateTimer);
      discountUpdateTimer = setTimeout(async () => {
        const pct = parseFloat(uspsPercentOffInput.value || '0');
        const dollar = parseFloat(uspsDollarOffInput.value || '0');
        if (isNaN(pct) || isNaN(dollar)) return;
        setLoading(true, 'Recalculating...', false);
        const response = await fetch(`/api/usps-market-discount/${jobId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            pct_off: pct / 100,
            dollar_off: dollar
          })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
          setLoading(false, '', false);
          return;
        }
        loadDashboard(currentSelection, false, true, true).then(() => loadPerCarrier(true));
      }, 450);
    }

    uspsPercentOffInput.addEventListener('input', queueDiscountUpdate);
    uspsDollarOffInput.addEventListener('input', queueDiscountUpdate);

    function formatNumber(value) {
      if (value === null || value === undefined || isNaN(value)) return '--';
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value);
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return '--';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(value);
    }

    function saasFeeForOrders(annualOrders) {
      if (!Number.isFinite(annualOrders) || annualOrders <= 0) return 0;
      if (annualOrders < 10000) return 99;
      if (annualOrders < 15000) return 199;
      if (annualOrders < 35000) return 299;
      return 399;
    }

    function normalizeCarrierKey(value) {
      return String(value || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '');
    }

    function buildCarrierDetailMap(details) {
      const map = {};
      (details || []).forEach((detail) => {
        const key = normalizeCarrierKey(detail && detail.carrier);
        if (!key) return;
        map[key] = detail;
      });
      return map;
    }

    function carrierPercent(detail) {
      if (!detail) return 0;
      let pct = Number(detail.orders_won_pct);
      if (!Number.isFinite(pct)) return 0;
      if (pct > 1) pct /= 100;
      return pct;
    }

    function carrierSpreadValue(detail) {
      if (!detail) return null;
      const spread = Number(detail.spread);
      return Number.isFinite(spread) ? spread : null;
    }

    function computeDealSpreadTotals() {
      const annualOrders = Number(dealAnnualOrders.value || 0);
      const adjustedOrdersText = dealAdjustedOrders.textContent || '';
      const adjustedOrders = Number(adjustedOrdersText.replace(/,/g, '')) || annualOrders;
      const avgLabel = Number(dealAvgLabelCost.value || 0);
      const selectedSet = new Set(currentSelection || []);
      const detailMap = buildCarrierDetailMap(dealCarrierDetails);

      if (adjustedOrders <= 0) {
        return { totalSpread: 0, spreadPerOrder: 0 };
      }

      let totalSpread = 0;
      if (selectedSet.has('USPS Market')) {
        const pct = carrierPercent(detailMap[normalizeCarrierKey('USPS Market')]);
        totalSpread += 0.2 * pct * adjustedOrders;
      }

      let upsPct = 0;
      if (selectedSet.has('UPS Ground')) {
        upsPct += carrierPercent(detailMap[normalizeCarrierKey('UPS Ground')]);
      }
      if (selectedSet.has('UPS Ground Saver')) {
        upsPct += carrierPercent(detailMap[normalizeCarrierKey('UPS Ground Saver')]);
      }
      if (upsPct > 0 && Number.isFinite(avgLabel)) {
        totalSpread += avgLabel * 0.11 * upsPct * adjustedOrders;
      }

      ['FedEx', 'Amazon', 'UniUni'].forEach((carrier) => {
        if (!selectedSet.has(carrier)) return;
        const detail = detailMap[normalizeCarrierKey(carrier)];
        const pct = carrierPercent(detail);
        const spread = carrierSpreadValue(detail);
        if (!pct || spread === null) return;
        totalSpread += spread * pct * adjustedOrders;
      });

      const spreadPerOrder = adjustedOrders > 0 ? totalSpread / adjustedOrders : 0;
      return { totalSpread, spreadPerOrder };
    }

    function updateDealSizing() {
      const annualOrders = Number(dealAnnualOrders.value || 0);
      const commentSold = toggleCommentSold.checked;
      const ebay = toggleEbay.checked;
      const liveSelling = toggleLiveSelling.checked;

      let adjusted = annualOrders;
      if (commentSold) adjusted *= 0.6;
      if (ebay) {
        adjusted *= liveSelling ? 0.6 : 0.95;
      }
      dealAdjustedOrders.textContent = formatNumber(adjusted);
      if (dealCarrierSpreadLoading) {
        dealCarrierSpreadLoading.classList.toggle('is-hidden', !dealCarrierDetailsPending);
      }
      const spreadTotals = computeDealSpreadTotals();
      dealSpreadPerOrder = spreadTotals.spreadPerOrder || 0;
      const carrierSpreadEl = document.getElementById('deal-carrier-spread');
      if (carrierSpreadEl) {
        carrierSpreadEl.textContent = formatCurrency(spreadTotals.totalSpread || 0);
      }
    }

    async function openDealSizing() {
      localStorage.removeItem(dealSizeStorageKey);
      dealCarrierDetails = [];
      dealCarrierDetailsPending = false;
      const response = await fetch(`/api/deal-sizing/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_carriers: currentSelection || [] })
      });
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        return;
      }
      const annualOrders = Number(data.annual_orders || localStorage.getItem('annual_orders') || 0);
      const winRate = Number(currentMetrics['% Orders We Could Win'] || 0) * 100;
      const avgLabel = Number(data.avg_label_cost || 0);
      const perLabelFee = 0.00;
      const feeOrderPct = 100 - winRate;
      const attachRate = 85;
      const saasFee = saasFeeForOrders(annualOrders);
      dealCarrierDetails = Array.isArray(data.carrier_details) ? data.carrier_details : [];
      dealCarrierDetailsPending = !!data.carrier_details_pending;

      dealAnnualOrders.value = annualOrders ? Math.round(annualOrders) : '';
      dealAvgLabelCost.value = Number.isFinite(avgLabel) ? avgLabel.toFixed(2).replace(/\.00$/, '') : '';
      dealPerLabelFee.value = Number.isFinite(perLabelFee) ? perLabelFee.toFixed(2) : '';
      dealFeeOrderPct.value = Number.isFinite(feeOrderPct) ? feeOrderPct.toFixed(1).replace(/\.0$/, '') : '';
      dealAttachRate.value = attachRate.toFixed(1).replace(/\.0$/, '');
      dealSaasFee.value = Number.isFinite(saasFee) ? saasFee.toFixed(0) : '';

      toggleLiveRow.style.display = toggleEbay.checked ? 'flex' : 'none';
      dealAttachUploadField.classList.toggle('is-hidden', attachRate <= 85);
      dealSizingModal.classList.remove('is-hidden');
      updateDealSizing();

      if (data.carrier_details_pending) {
        setTimeout(async () => {
          const refresh = await fetch(`/api/deal-sizing/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected_carriers: currentSelection || [] })
          });
          const refreshed = await refresh.json();
          if (!refreshed.error && Array.isArray(refreshed.carrier_details)) {
            dealCarrierDetails = refreshed.carrier_details;
            dealCarrierDetailsPending = !!refreshed.carrier_details_pending;
            updateDealSizing();
          }
        }, 900);
      }
    }

    dealSizingBtn.addEventListener('click', openDealSizing);
    dealSizingEdit.addEventListener('click', openDealSizing);
    dealSizingClose.addEventListener('click', () => dealSizingModal.classList.add('is-hidden'));
    dealSizingSave.addEventListener('click', () => {
      const attachRate = Number(dealAttachRate.value || 0);
      const requiresUpload = Number.isFinite(attachRate) && attachRate > 85;
      if (requiresUpload && !dealAttachUpload.files.length) {
        alert('Upload a screenshot of Redo Usage Dashboard');
        return;
      }
      const annualOrders = Number(dealAnnualOrders.value || 0);
      const perLabelFee = Number(dealPerLabelFee.value || 0);
      const feeOrderPct = (Number(dealFeeOrderPct.value || 0) || 0) / 100;
      const saasFee = Number(dealSaasFee.value || 0);
      const labelFeeTotal = perLabelFee * (feeOrderPct * annualOrders);
      const spreadTotals = computeDealSpreadTotals();
      const dealSize = spreadTotals.totalSpread + saasFee + labelFeeTotal;
      const dealValueEl = document.getElementById('metric-redo-deal-size');
      if (dealValueEl) {
        dealValueEl.textContent = formatCurrency(dealSize);
      }
      localStorage.setItem(dealSizeStorageKey, String(Number.isFinite(dealSize) ? dealSize : 0));
      const dealCard = document.querySelector('.metric-card--deal-sizing');
      if (dealCard) dealCard.classList.add('has-deal-size');
      dealSizingModal.classList.add('is-hidden');
    });
    dealSizingModal.addEventListener('click', (event) => {
      if (event.target === dealSizingModal) {
        dealSizingModal.classList.add('is-hidden');
      }
    });

    [dealAnnualOrders, dealAvgLabelCost, dealPerLabelFee, dealFeeOrderPct, dealAttachRate, dealSaasFee].forEach((el) => {
      if (!el) return;
      el.addEventListener('input', updateDealSizing);
    });

    dealFeeOrderPct.addEventListener('input', () => {
      const feePct = Number(dealFeeOrderPct.value || 0);
      dealFeeOrderPct.value = Number.isFinite(feePct)
        ? feePct.toFixed(1).replace(/\.0$/, '')
        : '';
    });

    dealAttachRate.addEventListener('input', () => {
      const rate = Number(dealAttachRate.value || 0);
      const showUpload = Number.isFinite(rate) && rate > 85;
      dealAttachUploadField.classList.toggle('is-hidden', !showUpload);
      dealAttachUpload.required = showUpload;
      if (!showUpload) {
        dealAttachUpload.value = '';
      }
    });

    toggleCommentSold.addEventListener('change', updateDealSizing);
    toggleEbay.addEventListener('change', () => {
      toggleLiveRow.style.display = toggleEbay.checked ? 'flex' : 'none';
      updateDealSizing();
    });
    toggleLiveSelling.addEventListener('change', updateDealSizing);
    togglePrinting.addEventListener('change', updateDealSizing);
  </script>
</body>
</html>
