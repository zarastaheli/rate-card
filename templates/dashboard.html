<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate card summary</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page-container">
    <div class="card card--tall">
      <div class="card-content">
        <div class="card-body balanced-body">
      <div class="breadcrumb">
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">1</span>
          <span class="breadcrumb-label">Raw invoice</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">2</span>
          <span class="breadcrumb-label">Normalize &amp; mapping</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">3</span>
          <span class="breadcrumb-label">Merchant pricing</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">4</span>
          <span class="breadcrumb-label">Redo carriers</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item active">
          <span class="breadcrumb-number">5</span>
          <span class="breadcrumb-label">Rate card</span>
        </div>
      </div>

      <div class="dashboard-header">
        <div>
          <h1>Rate Card Summary</h1>
          <p class="subtitle">Overview and carrier breakdown based on your selections</p>
        </div>
        <div class="dashboard-actions">
          <button class="button button-primary button-no-shadow" type="button" id="download-btn">Download Rate Card</button>
          <button class="button button-secondary" type="button" id="sharepoint-btn">View File In Sharepoint</button>
        </div>
      </div>

      <div id="dashboard-loading" class="dashboard-loading">
        <div class="dashboard-loading-spinner"></div>
        <div class="dashboard-loading-text">Loading summary...</div>
      </div>

      <div id="dashboard-content" class="dashboard-content is-hidden">
      <div class="section-block selected-carriers-section">
        <div class="section-title">Selected carriers</div>
        <div class="carrier-chips" id="selected-carriers"></div>
      </div>

      <div class="dashboard-banner is-hidden" id="annual-orders-banner">
        <span>Add annual orders to see spread</span>
        <button class="button button-secondary button-compact" type="button" id="annual-orders-btn">Add annual orders</button>
      </div>

      <div class="modal-overlay is-hidden" id="annual-orders-modal">
        <div class="modal-card">
          <div class="modal-title">Add annual orders</div>
          <p class="modal-subtitle">Enter the annual order count to calculate savings and spread</p>
          <input type="number" class="text-input modal-input" id="annual-orders-input" placeholder="Annual orders" min="1" />
          <div class="modal-actions">
            <button class="button button-secondary" type="button" id="annual-orders-cancel">Cancel</button>
            <button class="button button-primary" type="button" id="annual-orders-save">Save</button>
          </div>
          <div class="modal-loading is-hidden" id="annual-orders-loading">
            <span class="dashboard-loading-spinner"></span>
            <span>Calculatingâ€¦</span>
          </div>
        </div>
      </div>

      <div class="summary-grid" id="summary-grid">
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">Est. Merchant Annual Savings</div>
            <div class="metric-value" id="metric-merchant-savings">--</div>
          </div>
          <div class="metric-note">Estimate</div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">Est. Redo Deal Size</div>
            <div class="metric-value" id="metric-redo-deal-size">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">Total Spread Avaliable</div>
            <div class="metric-value" id="metric-spread-available">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">% Orders We Could Win</div>
            <div class="metric-value" id="metric-orders-could-win">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">% Orders Won W/ Spread</div>
            <div class="metric-value" id="metric-orders-won-spread">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
      </div>

      <div class="section-block is-hidden" id="breakdown-section">
        <div class="section-title">Carrier breakdown</div>
        <div class="breakdown-table">
          <div class="breakdown-row breakdown-header">
            <div>Carrier</div>
            <div>Est. Merchant Annual Savings</div>
            <div>Est. Redo Deal Size</div>
            <div>Total Spread Avaliable</div>
            <div>% Orders We Could Win</div>
            <div>% Orders Won W/ Spread</div>
          </div>
          <div class="breakdown-loading" id="breakdown-loading">Loading carrier breakdown...</div>
          <div id="carrier-breakdown"></div>
        </div>
      </div>

      <div class="usps-discount-row is-hidden" id="usps-discount-row">
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-percent-off">% Off USPS Market Rate</label>
          <div class="usps-discount-input">
            <input type="number" class="text-input" id="usps-percent-off" min="0" step="0.1" />
            <span class="usps-discount-suffix">%</span>
          </div>
        </div>
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-dollar-off">$ Off USPS Market Rate</label>
          <div class="usps-discount-input">
            <span class="usps-discount-prefix">$</span>
            <input type="number" class="text-input" id="usps-dollar-off" min="0" step="0.01" />
          </div>
        </div>
      </div>

      <div class="dashboard-footnote dashboard-footnote--alert">All Figures Are Estimates - Final Deal Size Will Be Determined By Deal Desk</div>
      <div class="dashboard-bottom-actions">
        <button class="button button-secondary" type="button" id="back-to-redo-btn">Back</button>
        <button class="button button-secondary" type="button" id="start-over-btn">Start over</button>
      </div>
      </div>

      </div>
      </div>
    </div>
  </div>

  <script>
    const jobId = '{{ job_id }}';
    const merchantName = '{{ merchant_name }}';
    const downloadBtn = document.getElementById('download-btn');
    const sharepointBtn = document.getElementById('sharepoint-btn');
    const backToRedoBtn = document.getElementById('back-to-redo-btn');
    const startOverBtn = document.getElementById('start-over-btn');
    const annualOrdersBanner = document.getElementById('annual-orders-banner');
    const annualOrdersBtn = document.getElementById('annual-orders-btn');
    const annualOrdersModal = document.getElementById('annual-orders-modal');
    const annualOrdersInput = document.getElementById('annual-orders-input');
    const annualOrdersCancel = document.getElementById('annual-orders-cancel');
    const annualOrdersSave = document.getElementById('annual-orders-save');
    const annualOrdersLoading = document.getElementById('annual-orders-loading');
    const uspsDiscountRow = document.getElementById('usps-discount-row');
    const uspsPercentOffInput = document.getElementById('usps-percent-off');
    const uspsDollarOffInput = document.getElementById('usps-dollar-off');

    downloadBtn.addEventListener('click', () => {
      window.location.href = `/download/${jobId}/rate-card`;
    });
    sharepointBtn.addEventListener('click', () => {
      window.open(`https://sharepoint.example.com?merchant=${encodeURIComponent(merchantName)}`, '_blank');
    });
    backToRedoBtn.addEventListener('click', () => {
      window.location.href = `/redo-carriers?job_id=${jobId}`;
    });
    startOverBtn.addEventListener('click', () => {
      localStorage.removeItem('job_id');
      localStorage.removeItem('detected_structure');
      localStorage.removeItem('merchant_name_suggestion');
      localStorage.removeItem('merchant_name');
      localStorage.removeItem('merchant_id');
      localStorage.removeItem('origin_zip');
      localStorage.removeItem('annual_orders');
      window.location.href = '/';
    });

    const metricMap = {
      'Est. Merchant Annual Savings': 'metric-merchant-savings',
      'Est. Redo Deal Size': 'metric-redo-deal-size',
      'Spread Available': 'metric-spread-available',
      '% Orders We Could Win': 'metric-orders-could-win',
      '% Orders Won W/ Spread': 'metric-orders-won-spread'
    };

    const suppressedMetrics = new Set([
      'Est. Merchant Annual Savings',
      'Est. Redo Deal Size',
      'Spread Available'
    ]);
    let annualOrdersMissing = false;
    let discountUpdateTimer = null;

    function formatMetric(label, value) {
      if (annualOrdersMissing && suppressedMetrics.has(label)) return '--';
      if (value === null || value === undefined || value === '') return '--';
      if (typeof value === 'string') return value;
      if (label.includes('%')) {
        return `${Math.round(value * 100)}%`;
      }
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(value);
    }

    function parseMetricValue(value) {
      if (value === null || value === undefined || value === '') return null;
      if (typeof value === 'number') return value;
      const cleaned = String(value).replace(/[$,%]/g, '').replace(/,/g, '').trim();
      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function renderSummary(metrics) {
      Object.entries(metricMap).forEach(([label, id]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = formatMetric(label, metrics[label]);
      });
    }

    function renderSelectedCarriers(available, selected) {
      const container = document.getElementById('selected-carriers');
      container.innerHTML = '';
      const selectedSet = new Set(selected);
      const ordered = [
        ...available.filter(carrier => selectedSet.has(carrier)),
        ...available.filter(carrier => !selectedSet.has(carrier))
      ];
      ordered.forEach((carrier) => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'carrier-chip';
        if (selectedSet.has(carrier)) {
          chip.classList.add('is-selected');
        }
        chip.textContent = carrier;
        chip.dataset.carrier = carrier;
        container.appendChild(chip);
      });
    }

    function renderBreakdown(perCarrier) {
      const container = document.getElementById('carrier-breakdown');
      container.innerHTML = '';
      const columns = [
        { key: 'Est. Merchant Annual Savings', label: 'Est. Merchant Annual Savings' },
        { key: 'Est. Redo Deal Size', label: 'Est. Redo Deal Size' },
        { key: 'Spread Available', label: 'Total Spread Avaliable' },
        { key: '% Orders We Could Win', label: '% Orders We Could Win' },
        { key: '% Orders Won W/ Spread', label: '% Orders Won W/ Spread' }
      ];
      const maxValues = {};
      columns.forEach(({ key }) => {
        const values = perCarrier
          .map(row => parseMetricValue((row.metrics || {})[key]))
          .filter(val => val !== null);
        maxValues[key] = values.length ? Math.max(...values) : null;
      });
      perCarrier.forEach((row) => {
        const metrics = row.metrics || {};
        const rowEl = document.createElement('div');
        rowEl.className = 'breakdown-row';
        const formatWithHighlight = (key) => {
          if (annualOrdersMissing && suppressedMetrics.has(key)) {
            return '--';
          }
          const raw = metrics[key];
          const formatted = formatMetric(key, raw);
          const numeric = parseMetricValue(raw);
          const max = maxValues[key];
          if (numeric !== null && max !== null && numeric === max) {
            return `<span class="metric-pill">${formatted}</span>`;
          }
          return formatted;
        };
        rowEl.innerHTML = `
          <div>${row.carrier}</div>
          <div>${formatWithHighlight('Est. Merchant Annual Savings')}</div>
          <div>${formatWithHighlight('Est. Redo Deal Size')}</div>
          <div>${formatWithHighlight('Spread Available')}</div>
          <div>${formatWithHighlight('% Orders We Could Win')}</div>
          <div>${formatWithHighlight('% Orders Won W/ Spread')}</div>
        `;
        container.appendChild(rowEl);
      });
    }

    let currentSelection = [];
    let selectionTimer = null;

    function setLoading(isLoading, message, hideContent) {
      const loadingEl = document.getElementById('dashboard-loading');
      const contentEl = document.getElementById('dashboard-content');
      if (message) {
        const textEl = loadingEl.querySelector('.dashboard-loading-text');
        if (textEl) textEl.textContent = message;
      }
      loadingEl.style.display = isLoading ? 'flex' : 'none';
      contentEl.classList.toggle('is-dimmed', isLoading && !hideContent);
      if (hideContent) {
        contentEl.classList.toggle('is-hidden', isLoading);
      } else {
        contentEl.classList.remove('is-hidden');
      }
    }

    async function loadDashboard(selected = null, initial = false, recalculating = false) {
      if (initial) {
        setLoading(true, 'Loading summary...', true);
      } else if (recalculating) {
        setLoading(true, 'Recalculating...', false);
      }
      const options = selected
        ? {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ selected_carriers: selected })
          }
        : {};
      const response = await fetch(`/api/dashboard/${jobId}`, options);
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        setLoading(false, '', false);
        return;
      }
      if (data.summary_pending) {
        if (initial) {
          setLoading(true, 'Loading summary...', true);
        } else if (recalculating) {
          setLoading(true, 'Recalculating...', false);
        }
        setTimeout(() => loadDashboard(selected, initial, recalculating), 700);
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.summary_pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.show_usps_market_discount) {
        const pct = Number(data.usps_market_pct_off) * 100;
        uspsPercentOffInput.value = Number.isFinite(pct) ? pct.toFixed(1).replace(/\.0$/, '') : '5';
        uspsDollarOffInput.value = Number.isFinite(Number(data.usps_market_dollar_off))
          ? Number(data.usps_market_dollar_off).toFixed(2).replace(/\.00$/, '')
          : '0';
      }
      currentSelection = data.selected_carriers || [];
      renderSummary(data.overall || {});
      renderSelectedCarriers(data.available_carriers || [], currentSelection);
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) {
        breakdownSection.classList.remove('is-hidden');
      }
      setLoading(false, '', false);
    }

    async function loadPerCarrier() {
      const loadingEl = document.getElementById('breakdown-loading');
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) breakdownSection.classList.remove('is-hidden');
      loadingEl.style.display = 'block';
      const response = await fetch(`/api/dashboard/${jobId}?per_carrier=1`);
      const data = await response.json();
      if (data.error) {
        loadingEl.textContent = 'Unable to load carrier breakdown.';
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.per_carrier_total) {
        loadingEl.textContent = `Calculating carrier breakdown ${data.per_carrier_count || 0}/${data.per_carrier_total}...`;
      }
      if (data.per_carrier && data.per_carrier.length) {
        renderBreakdown(data.per_carrier);
      }
      if (data.pending) {
        setTimeout(loadPerCarrier, 900);
        return;
      }
      loadingEl.style.display = 'none';
    }

    document.addEventListener('click', (event) => {
      const chip = event.target.closest('.carrier-chip');
      if (!chip || !chip.dataset.carrier) return;
      if (selectionTimer) clearTimeout(selectionTimer);
      selectionTimer = setTimeout(() => {
        const carriers = Array.from(document.querySelectorAll('.carrier-chip'))
          .map(el => el.dataset.carrier);
        const selected = Array.from(document.querySelectorAll('.carrier-chip.is-selected'))
          .map(el => el.dataset.carrier);
        const target = chip.dataset.carrier;
        const nextSelected = selected.includes(target)
          ? selected.filter(c => c !== target)
          : [...selected, target];
        if (!nextSelected.length) {
          renderSelectedCarriers(carriers, currentSelection);
          return;
        }
        loadDashboard(nextSelected, false, true);
      }, 200);
    });

    loadDashboard(null, true).then(loadPerCarrier);

    function openAnnualOrdersModal() {
      annualOrdersModal.classList.remove('is-hidden');
      annualOrdersInput.value = '';
      annualOrdersInput.focus();
    }

    function closeAnnualOrdersModal() {
      if (!annualOrdersLoading.classList.contains('is-hidden')) return;
      annualOrdersModal.classList.add('is-hidden');
    }

    async function saveAnnualOrders() {
      const cleaned = String(annualOrdersInput.value || '').replace(/[, ]/g, '');
      if (!cleaned || isNaN(cleaned)) {
        alert('Please enter a valid number');
        return;
      }
      const value = Math.floor(Number(cleaned));
      if (value <= 0) {
        alert('Annual orders must be greater than 0');
        return;
      }
      annualOrdersLoading.classList.remove('is-hidden');
      annualOrdersSave.disabled = true;
      annualOrdersCancel.disabled = true;
      const response = await fetch(`/api/annual-orders/${jobId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ annual_orders: value })
      });
      const data = await response.json();
      annualOrdersLoading.classList.add('is-hidden');
      annualOrdersSave.disabled = false;
      annualOrdersCancel.disabled = false;
      if (data.error) {
        alert(data.error);
        return;
      }
      localStorage.setItem('annual_orders', String(value));
      closeAnnualOrdersModal();
      loadDashboard(currentSelection, false, true).then(loadPerCarrier);
    }

    annualOrdersBtn.addEventListener('click', openAnnualOrdersModal);
    annualOrdersCancel.addEventListener('click', closeAnnualOrdersModal);
    annualOrdersSave.addEventListener('click', saveAnnualOrders);
    annualOrdersModal.addEventListener('click', (event) => {
      if (event.target === annualOrdersModal) {
        closeAnnualOrdersModal();
      }
    });

    function queueDiscountUpdate() {
      if (discountUpdateTimer) clearTimeout(discountUpdateTimer);
      discountUpdateTimer = setTimeout(async () => {
        const pct = parseFloat(uspsPercentOffInput.value || '0');
        const dollar = parseFloat(uspsDollarOffInput.value || '0');
        if (isNaN(pct) || isNaN(dollar)) return;
        setLoading(true, 'Recalculating...', false);
        const response = await fetch(`/api/usps-market-discount/${jobId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            pct_off: pct / 100,
            dollar_off: dollar
          })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
          setLoading(false, '', false);
          return;
        }
        loadDashboard(currentSelection, false, true).then(loadPerCarrier);
      }, 450);
    }

    uspsPercentOffInput.addEventListener('input', queueDiscountUpdate);
    uspsDollarOffInput.addEventListener('input', queueDiscountUpdate);
  </script>
</body>
</html>
