<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate card summary</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page-container">
    <div class="card card--tall">
      <div class="card-content">
        <div class="card-body balanced-body">
      <div class="breadcrumb">
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">1</span>
          <span class="breadcrumb-label">Raw invoice</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">2</span>
          <span class="breadcrumb-label">Normalize &amp; mapping</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">3</span>
          <span class="breadcrumb-label">Merchant pricing</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item completed">
          <span class="breadcrumb-number">4</span>
          <span class="breadcrumb-label">Redo carriers</span>
        </div>
        <div class="breadcrumb-separator"></div>
        <div class="breadcrumb-item active">
          <span class="breadcrumb-number">5</span>
          <span class="breadcrumb-label">Rate card</span>
        </div>
      </div>

      <div class="dashboard-header">
        <div>
          <h1>Rate Card Summary</h1>
          <p class="subtitle">Overview and carrier breakdown based on your selections</p>
        </div>
        <div class="dashboard-actions">
          <div class="dashboard-actions-stack">
            <button class="button button-primary button-no-shadow" type="button" id="download-btn">Download Rate Card</button>
            <button class="button button-secondary" type="button" id="sharepoint-btn">View File In Sharepoint</button>
          </div>
        </div>
      </div>

      <div id="dashboard-loading" class="dashboard-loading">
        <div class="dashboard-loading-spinner"></div>
        <div class="dashboard-loading-text">Loading summary...</div>
      </div>

      <div id="dashboard-content" class="dashboard-content is-hidden">
      <div class="section-block selected-carriers-section">
        <div class="section-title">Redo Carriers Sold</div>
        <div class="carrier-chips" id="selected-carriers"></div>
      </div>

      <div class="dashboard-banner is-hidden" id="annual-orders-banner">
        <span>Add annual orders to see spread</span>
        <button class="button button-secondary button-compact" type="button" id="annual-orders-btn">Add annual orders</button>
      </div>

      <div class="modal-overlay is-hidden" id="annual-orders-modal">
        <div class="modal-card">
          <div class="modal-title">Add Annual Orders</div>
          <p class="modal-subtitle">Enter the annual order count to calculate savings and spread</p>
          <input type="number" class="text-input modal-input" id="annual-orders-input" placeholder="Annual orders" min="1" />
          <div class="modal-actions">
            <button class="button button-secondary" type="button" id="annual-orders-cancel">Cancel</button>
            <button class="button button-primary" type="button" id="annual-orders-save">Save</button>
          </div>
          <div class="modal-loading is-hidden" id="annual-orders-loading">
            <span class="dashboard-loading-spinner"></span>
            <span>Calculating…</span>
          </div>
        </div>
      </div>

      <div class="modal-overlay is-hidden" id="deal-sizing-modal">
        <div class="modal-card modal-card--wide">
          <div class="modal-title">Deal Sizing</div>
          <p class="modal-subtitle">Adjust inputs to refine the sizing estimate</p>

          <div class="deal-sizing-carriers">
            <div class="deal-sizing-carriers-title">Redo Carriers Sold</div>
            <div class="carrier-chips carrier-chips--compact" id="deal-sizing-carriers"></div>
          </div>

          <div class="deal-sizing-summary">
            <div class="deal-summary-card">
              <div class="deal-summary-label">
                <span class="label-with-hint">Carrier Spread
                  <button class="calc-hint" type="button" aria-label="How calculated" title="Total spread: USPS $0.20/order; UPS avg label cost * 11%; FedEx/Amazon/UniUni use Carrier Details spread. For each carrier: spread * % orders won * adjusted orders.">?</button>
                </span>
              </div>
              <div class="deal-summary-value" id="deal-carrier-spread">$--</div>
              <div class="deal-summary-spinner is-hidden" id="deal-carrier-spread-loading">
                <span class="dashboard-loading-spinner"></span>
                <span>Calculating...</span>
              </div>
            </div>
            <div class="deal-summary-card">
              <div class="deal-summary-label">
                <span class="label-with-hint">Adjusted Annual Orders
                  <button class="calc-hint" type="button" aria-label="How calculated" title="Adjusted Annual Orders = Annual Orders with CommentSold/Ebay/Live Selling reductions applied.">?</button>
                </span>
              </div>
              <div class="deal-summary-value" id="deal-adjusted-orders">--</div>
            </div>
            <div class="deal-summary-card">
              <div class="deal-summary-label">
                <span class="label-with-hint">Attach Rate
                  <button class="calc-hint" type="button" aria-label="How calculated" title="Attach Rate = user input (default 85%). >85% requires upload.">?</button>
                </span>
              </div>
              <div class="deal-summary-input">
                <input type="number" class="text-input deal-input-filled deal-input-attach" id="deal-attach-rate" min="0" max="100" step="0.1" />
                <span class="deal-sizing-suffix">%</span>
              </div>
            </div>
          </div>

          <div class="deal-sizing-grid deal-sizing-grid--compact">
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-saas-fee">
                <span class="label-with-hint">SaaS Fee: <span id="deal-saas-tier">Starter Tier</span>
                  <button class="calc-hint" type="button" aria-label="How calculated" title="SaaS Fee tiers by annual orders: 0-5k $99, 5-15k $199, 15-35k $299, 35-50k $399, 50k+ Enterprise.">?</button>
                </span>
              </label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-saas-fee" min="0" step="0.01" />
              </div>
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-per-label-fee">
                <span class="label-with-hint">Per Label Fee
                  <button class="calc-hint" type="button" aria-label="How calculated" title="Per Label Fee = user input. Total = per label fee * (% of orders with fee) * annual orders.">?</button>
                </span>
              </label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-per-label-fee" min="0" step="0.01" />
              </div>
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-fee-order-pct">
                <span class="label-with-hint">% Of Orders With Fee
                  <button class="calc-hint" type="button" aria-label="How calculated" title="% of Orders With Fee = user input. Used with Per Label Fee to compute fee total.">?</button>
                </span>
              </label>
              <div class="deal-sizing-input">
                <input type="number" class="text-input deal-input-filled" id="deal-fee-order-pct" min="0" max="100" step="0.1" />
                <span class="deal-sizing-suffix">%</span>
              </div>
            </div>
          </div>

          <div class="deal-sizing-grid deal-sizing-grid--inputs">
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-annual-orders">
                <span class="label-with-hint">Annual Orders
                  <button class="calc-hint" type="button" aria-label="How calculated" title="From mapping annual orders input (saved in mapping.json).">?</button>
                </span>
                <span class="required-asterisk">*</span>
              </label>
              <input type="number" class="text-input deal-input-filled" id="deal-annual-orders" min="0" required />
            </div>
            <div class="deal-sizing-field">
              <label class="deal-sizing-label" for="deal-avg-label-cost">
                <span class="label-with-hint">Average Label Cost
                  <button class="calc-hint" type="button" aria-label="How calculated" title="Average Label Cost = mean of Label Cost from normalized invoice.">?</button>
                </span>
                <span class="required-asterisk">*</span>
              </label>
              <div class="deal-sizing-input">
                <span class="deal-sizing-prefix">$</span>
                <input type="number" class="text-input deal-input-filled" id="deal-avg-label-cost" min="0" step="0.01" required />
              </div>
            </div>
          </div>

          <div class="deal-sizing-upload-block" id="deal-attach-upload-field">
            <div class="deal-sizing-upload-drop">
              <span class="deal-upload-icon">⬆︎</span>
              <div class="deal-sizing-upload-text">
                <strong>Upload a Screenshot of Redo Usage Dashboard</strong>
                <span>Required if attach rate is above 85%</span>
              </div>
              <input type="file" class="deal-sizing-file" id="deal-attach-upload" accept="image/*,.pdf" />
            </div>
          </div>

          <div class="deal-sizing-toggles">
            <div class="toggle-row toggle-row--flat">
              <span class="label-with-hint">CommentSold
                <button class="calc-hint" type="button" aria-label="How calculated" title="CommentSold reduces adjusted orders to 60%.">?</button>
              </span>
              <label class="switch">
                <input type="checkbox" id="toggle-commentsold" />
                <span class="slider"></span>
              </label>
            </div>
            <div class="toggle-row toggle-row--flat toggle-row--stack">
              <div class="toggle-stack">
                <div class="toggle-stack-row">
                  <span class="label-with-hint">Ebay
                    <button class="calc-hint" type="button" aria-label="How calculated" title="Ebay reduces adjusted orders to 95% (or 60% if Live Selling).">?</button>
                  </span>
                  <label class="switch">
                    <input type="checkbox" id="toggle-ebay" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="toggle-stack-row toggle-stack-row--nested" id="toggle-live-row">
                  <span class="label-with-hint">Live Selling
                    <button class="calc-hint" type="button" aria-label="How calculated" title="Live Selling only applies when Ebay is on; adjusted orders reduce to 60%.">?</button>
                  </span>
                  <label class="switch">
                    <input type="checkbox" id="toggle-live-selling" />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
            <div class="toggle-row toggle-row--flat">
              <span class="label-with-hint">Printing Today
                <button class="calc-hint" type="button" aria-label="How calculated" title="Printing Today currently does not change calculations.">?</button>
              </span>
              <label class="switch">
                <input type="checkbox" id="toggle-printing" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="modal-actions modal-actions--spread">
            <button class="button button-secondary" type="button" id="deal-sizing-close">Close</button>
            <button class="button button-primary" type="button" id="deal-sizing-save">Save</button>
          </div>
        </div>
      </div>

      <div class="summary-grid" id="summary-grid">
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">
              <span class="label-with-hint">Est. Merchant Annual Savings
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C5 (Est. Merchant Annual Savings).">?</button>
              </span>
            </div>
            <div class="metric-value" id="metric-merchant-savings">--</div>
          </div>
          <div class="metric-note">Estimate</div>
        </div>
        <div class="metric-card metric-card--deal-sizing">
          <button class="deal-sizing-edit-btn" type="button" id="deal-sizing-edit" aria-label="Expand deal size"></button>
          <div class="metric-main">
            <div class="metric-label">
              <span class="label-with-hint">Est. Redo Deal Size
                <button class="calc-hint" type="button" aria-label="How calculated" title="Deal size = total spread + per-label fees + SaaS (from deal sizing inputs).">?</button>
              </span>
            </div>
            <div class="metric-value metric-value--deal">
              <span id="metric-redo-deal-size">--</span>
            </div>
            <button class="metric-action deal-sizing-cta" type="button" id="deal-sizing-btn">
              Click to Deal Size
            </button>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">
              <span class="label-with-hint">Total Spread Avaliable
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C7 (Total Spread Available).">?</button>
              </span>
            </div>
            <div class="metric-value" id="metric-spread-available">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">
              <span class="label-with-hint">% Orders We Could Win
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C11 (% Orders We Could Win).">?</button>
              </span>
            </div>
            <div class="metric-value" id="metric-orders-could-win">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
        <div class="metric-card">
          <div class="metric-main">
            <div class="metric-label">
              <span class="label-with-hint">% Orders Won W/ Spread
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C12 (% Orders Won W/ Spread).">?</button>
              </span>
            </div>
            <div class="metric-value" id="metric-orders-won-spread">--</div>
          </div>
          <div class="metric-note metric-note--placeholder"></div>
        </div>
      </div>

      <div class="section-block is-hidden" id="breakdown-section">
        <div class="section-title">Carrier breakdown</div>
        <div class="breakdown-table">
          <div class="breakdown-row breakdown-header">
            <div>Carrier</div>
            <div>
              <span class="label-with-hint">Est. Merchant Annual Savings
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C5 computed with only this carrier enabled.">?</button>
              </span>
            </div>
            <div>
              <span class="label-with-hint">Est. Redo Deal Size
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C6 computed with only this carrier enabled.">?</button>
              </span>
            </div>
            <div>
              <span class="label-with-hint">Total Spread Avaliable
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C7 computed with only this carrier enabled.">?</button>
              </span>
            </div>
            <div>
              <span class="label-with-hint">% Orders We Could Win
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C11 computed with only this carrier enabled.">?</button>
              </span>
            </div>
            <div>
              <span class="label-with-hint">% Orders Won W/ Spread
                <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C12 computed with only this carrier enabled.">?</button>
              </span>
            </div>
          </div>
          <div class="breakdown-loading" id="breakdown-loading">Loading carrier breakdown...</div>
          <div id="carrier-breakdown"></div>
        </div>
      </div>

      <div class="usps-discount-row is-hidden" id="usps-discount-row">
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-percent-off">
            <span class="label-with-hint">% Off USPS Market Rate
              <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C19.">?</button>
            </span>
          </label>
          <div class="usps-discount-input">
            <input type="number" class="text-input" id="usps-percent-off" min="0" step="0.1" />
            <span class="usps-discount-suffix">%</span>
          </div>
        </div>
        <div class="usps-discount-card">
          <label class="usps-discount-label" for="usps-dollar-off">
            <span class="label-with-hint">$ Off USPS Market Rate
              <button class="calc-hint" type="button" aria-label="How calculated" title="Rate card: Pricing & Summary!C20.">?</button>
            </span>
          </label>
          <div class="usps-discount-input">
            <span class="usps-discount-prefix">$</span>
            <input type="number" class="text-input" id="usps-dollar-off" min="0" step="0.01" />
          </div>
        </div>
      </div>

      <div class="dashboard-footnote dashboard-footnote--alert">All Figures Are Estimates - Final Deal Size Will Be Determined By Deal Desk</div>
      <div class="dashboard-bottom-actions">
        <button class="button button-secondary" type="button" id="back-to-redo-btn">Back</button>
        <button class="button button-secondary" type="button" id="start-over-btn">Save And Return To Home</button>
      </div>
      </div>

      </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const jobId = '{{ job_id }}';
    const merchantName = '{{ merchant_name }}';
    const downloadBtn = document.getElementById('download-btn');
    const sharepointBtn = document.getElementById('sharepoint-btn');
    const saveDashboardBtn = document.getElementById('save-dashboard-btn');
    const backToRedoBtn = document.getElementById('back-to-redo-btn');
    const startOverBtn = document.getElementById('start-over-btn');
    const annualOrdersBanner = document.getElementById('annual-orders-banner');
    const annualOrdersBtn = document.getElementById('annual-orders-btn');
    const annualOrdersModal = document.getElementById('annual-orders-modal');
    const annualOrdersInput = document.getElementById('annual-orders-input');
    const annualOrdersCancel = document.getElementById('annual-orders-cancel');
    const annualOrdersSave = document.getElementById('annual-orders-save');
    const annualOrdersLoading = document.getElementById('annual-orders-loading');
    const uspsDiscountRow = document.getElementById('usps-discount-row');
    const uspsPercentOffInput = document.getElementById('usps-percent-off');
    const uspsDollarOffInput = document.getElementById('usps-dollar-off');
    const selectedCarriersEl = document.getElementById('selected-carriers');
    const dealSizingCarriersEl = document.getElementById('deal-sizing-carriers');
    const dealSizingBtn = document.getElementById('deal-sizing-btn');
    const dealSizingEdit = document.getElementById('deal-sizing-edit');
    const dealSizingModal = document.getElementById('deal-sizing-modal');
    const dealSizingClose = document.getElementById('deal-sizing-close');
    const dealAnnualOrders = document.getElementById('deal-annual-orders');
    const dealAvgLabelCost = document.getElementById('deal-avg-label-cost');
    const dealPerLabelFee = document.getElementById('deal-per-label-fee');
    const dealFeeOrderPct = document.getElementById('deal-fee-order-pct');
    const dealAttachRate = document.getElementById('deal-attach-rate');
    const dealAttachUploadField = document.getElementById('deal-attach-upload-field');
    const dealAttachUpload = document.getElementById('deal-attach-upload');
    const dealSaasFee = document.getElementById('deal-saas-fee');
    const dealSaasTierLabel = document.getElementById('deal-saas-tier');
    const dealAdjustedOrders = document.getElementById('deal-adjusted-orders');
    const toggleCommentSold = document.getElementById('toggle-commentsold');
    const toggleEbay = document.getElementById('toggle-ebay');
    const toggleLiveSelling = document.getElementById('toggle-live-selling');
    const toggleLiveRow = document.getElementById('toggle-live-row');
    const togglePrinting = document.getElementById('toggle-printing');
    const dealSizingSave = document.getElementById('deal-sizing-save');
    const dealSizingCard = document.querySelector('.metric-card--deal-sizing');
    const dealSizeStorageKey = `deal_size_value_${jobId}`;
    const dealInputsStorageKey = `deal_inputs_${jobId}`;
    const dealCarrierSpreadLoading = document.getElementById('deal-carrier-spread-loading');

    function _sanitizeFilename(value) {
      return String(value || 'Merchant')
        .trim()
        .replace(/\s+/g, ' ')
        .replace(/[^a-zA-Z0-9 _-]/g, '')
        .replace(/\s/g, ' ');
    }

    function _downloadCanvas(canvas, filename) {
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    if (saveDashboardBtn) {
      saveDashboardBtn.addEventListener('click', async () => {
        if (typeof html2canvas !== 'function') {
          alert('Screenshot tool unavailable. Please try again.');
          return;
        }
        const target = document.querySelector('.card.card--tall') || document.body;
        try {
          const canvas = await html2canvas(target, {
            backgroundColor: '#ffffff',
            scale: window.devicePixelRatio || 1
          });
          const safeName = _sanitizeFilename(merchantName) || 'Merchant';
          _downloadCanvas(canvas, `${safeName} dashboard.png`);
        } catch (err) {
          console.error('Dashboard capture failed:', err);
          alert('Unable to capture dashboard. Please try again.');
        }
      });
    }
    const SHOW_CALC_HINTS = false;

    if (SHOW_CALC_HINTS) {
      document.documentElement.classList.add('show-calc-hints');
      const hintButtons = Array.from(document.querySelectorAll('.calc-hint'));
      hintButtons.forEach((button) => {
        const title = button.getAttribute('title') || '';
        if (title && !button.dataset.hint) {
          button.dataset.hint = title;
        }
        button.removeAttribute('title');
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const isOpen = button.classList.contains('is-open');
          hintButtons.forEach((btn) => btn.classList.remove('is-open'));
          if (!isOpen) {
            button.classList.add('is-open');
          }
        });
      });
      document.addEventListener('click', () => {
        hintButtons.forEach((btn) => btn.classList.remove('is-open'));
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hintButtons.forEach((btn) => btn.classList.remove('is-open'));
        }
      });
    }

    downloadBtn.addEventListener('click', () => {
      window.location.href = `/download/${jobId}/rate-card`;
    });
    sharepointBtn.addEventListener('click', () => {
      window.open(
        'https://redotechinc.sharepoint.com/sites/Redo/Shared%20Documents/Forms/AllItems.aspx?id=%2Fsites%2FRedo%2FShared%20Documents%2FAll%20Rate%20Cards%2FUpdating&viewid=90e9a3fe%2Df7a4%2D42c6%2Da353%2D200c53d2e4f3&view=7',
        '_blank'
      );
    });
    backToRedoBtn.addEventListener('click', () => {
      window.location.href = `/redo-carriers?job_id=${jobId}`;
    });
    startOverBtn.addEventListener('click', () => {
      localStorage.removeItem('job_id');
      localStorage.removeItem('detected_structure');
      localStorage.removeItem('merchant_name_suggestion');
      localStorage.removeItem('merchant_name');
      localStorage.removeItem('merchant_id');
      localStorage.removeItem('origin_zip');
      localStorage.removeItem('annual_orders');
      localStorage.removeItem('flow_type');
      localStorage.removeItem(dealSizeStorageKey);
      localStorage.removeItem(dealInputsStorageKey);
      window.location.href = '/';
    });

    const metricMap = {
      'Est. Merchant Annual Savings': 'metric-merchant-savings',
      'Est. Redo Deal Size': 'metric-redo-deal-size',
      'Spread Available': 'metric-spread-available',
      '% Orders We Could Win': 'metric-orders-could-win',
      '% Orders Won W/ Spread': 'metric-orders-won-spread'
    };

    const suppressedMetrics = new Set([
      'Est. Merchant Annual Savings',
      'Est. Redo Deal Size',
      'Spread Available'
    ]);
    let annualOrdersMissing = false;
    let discountUpdateTimer = null;
    let currentMetrics = {};
    let dealSpreadPerOrder = 0;
    let dealCarrierDetails = [];
    let dealCarrierDetailsPending = false;
    let lastPerCarrier = [];

    function formatMetric(label, value) {
      if (annualOrdersMissing && suppressedMetrics.has(label)) return '--';
      if (value === null || value === undefined || value === '') return '--';
      if (typeof value === 'string') return value;
      if (label.includes('%')) {
        const pct = Math.round(value * 100);
        const bounded = Math.max(0, Math.min(100, pct));
        return `${bounded}%`;
      }
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(value);
    }

    function parseMetricValue(value) {
      if (value === null || value === undefined || value === '') return null;
      if (typeof value === 'number') return value;
      const cleaned = String(value).replace(/[$,%]/g, '').replace(/,/g, '').trim();
      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function getSavedDealSize() {
      const raw = localStorage.getItem(dealSizeStorageKey);
      if (!raw) return null;
      const parsed = Number(raw);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function getStoredDealInputs() {
      try {
        const raw = localStorage.getItem(dealInputsStorageKey);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch (err) {
        return null;
      }
    }

    function saveDealInputs(inputs) {
      localStorage.setItem(dealInputsStorageKey, JSON.stringify(inputs));
    }

    function parseNumberValue(value) {
      if (value === null || value === undefined) return NaN;
      if (typeof value === 'number') return value;
      const cleaned = String(value).replace(/,/g, '').trim();
      const parsed = Number(cleaned);
      return parsed;
    }

    function hasUsableDealInputs(stored) {
      if (!stored || typeof stored !== 'object') return false;
      const annualOrders = parseNumberValue(stored.annualOrders);
      const avgLabelCost = parseNumberValue(stored.avgLabelCost);
      const attachRate = parseNumberValue(stored.attachRate);
      const perLabelFee = parseNumberValue(stored.perLabelFee);
      const feeOrderPct = parseNumberValue(stored.feeOrderPct);
      const saasFee = parseNumberValue(stored.saasFee);
      return (
        (Number.isFinite(annualOrders) && annualOrders > 0) ||
        (Number.isFinite(avgLabelCost) && avgLabelCost > 0) ||
        (Number.isFinite(attachRate) && attachRate > 0) ||
        (Number.isFinite(perLabelFee) && perLabelFee > 0) ||
        (Number.isFinite(feeOrderPct) && feeOrderPct > 0) ||
        (Number.isFinite(saasFee) && saasFee > 0) ||
        !!stored.commentSold ||
        !!stored.ebay ||
        !!stored.liveSelling
      );
    }

    function renderSummary(metrics) {
      currentMetrics = metrics || {};
      Object.entries(metricMap).forEach(([label, id]) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (label === 'Est. Redo Deal Size') {
          const saved = getSavedDealSize();
          el.textContent = saved !== null ? formatCurrency(saved) : '--';
          return;
        }
        el.textContent = formatMetric(label, metrics[label]);
      });
      const dealValueEl = document.getElementById('metric-redo-deal-size');
      if (dealSizingCard && dealValueEl) {
        const saved = getSavedDealSize();
        dealSizingCard.classList.toggle('has-deal-size', saved !== null);
      }
    }

    let carrierPercentages = {};

    function formatCarrierPercent(value) {
      if (!Number.isFinite(value)) return '';
      return `${Math.round(value * 100)}`;
    }

    const hiddenCarriers = new Set(['FedEx']);

    function renderSelectedCarriers(available, selected, options = {}) {
      const containers = options.containers || [];
      const showPercent = !!options.showPercent;
      containers.forEach((container) => {
        if (container) container.innerHTML = '';
      });
      const selectedSet = new Set(selected);
      const filteredAvailable = available.filter(carrier => !hiddenCarriers.has(carrier));
      const ordered = [
        ...filteredAvailable.filter(carrier => selectedSet.has(carrier)),
        ...filteredAvailable.filter(carrier => !selectedSet.has(carrier))
      ];
      ordered.forEach((carrier) => {
        containers.forEach((container) => {
          if (!container) return;
          const chip = document.createElement('button');
          chip.type = 'button';
          chip.className = 'carrier-chip';
          if (selectedSet.has(carrier)) {
            chip.classList.add('is-selected');
          }
          if (showPercent) {
            chip.classList.add('carrier-chip--with-percent');
            const percentText = formatCarrierPercent(carrierPercentages[carrier]);
            chip.innerHTML = `
              <span class="carrier-chip-label">${carrier}</span>
              <span class="carrier-chip-percent">${percentText}</span>
            `;
          } else {
            chip.textContent = carrier;
          }
          chip.dataset.carrier = carrier;
          container.appendChild(chip);
        });
      });
    }

    function renderCarrierBars(available, selected) {
      renderSelectedCarriers(available, selected, {
        containers: [selectedCarriersEl],
        showPercent: false
      });
      renderSelectedCarriers(available, selected, {
        containers: [dealSizingCarriersEl],
        showPercent: false
      });
    }

    function renderBreakdown(perCarrier) {
      const container = document.getElementById('carrier-breakdown');
      container.innerHTML = '';
      lastPerCarrier = perCarrier || [];
      const columns = [
        { key: 'Est. Merchant Annual Savings', label: 'Est. Merchant Annual Savings' },
        { key: 'Est. Redo Deal Size', label: 'Est. Redo Deal Size' },
        { key: 'Spread Available', label: 'Total Spread Avaliable' },
        { key: '% Orders We Could Win', label: '% Orders We Could Win' },
        { key: '% Orders Won W/ Spread', label: '% Orders Won W/ Spread' }
      ];
      const breakdownHints = {
        'Est. Merchant Annual Savings': 'Rate card: Pricing & Summary!C5 computed with only this carrier enabled.',
        'Est. Redo Deal Size': 'Rate card: Pricing & Summary!C6 computed with only this carrier enabled.',
        'Spread Available': 'Rate card: Pricing & Summary!C7 computed with only this carrier enabled.',
        '% Orders We Could Win': 'Rate card: Pricing & Summary!C11 computed with only this carrier enabled.',
        '% Orders Won W/ Spread': 'Rate card: Pricing & Summary!C12 computed with only this carrier enabled.'
      };
      const storedInputs = getStoredDealInputs();
      const useDealInputs = hasUsableDealInputs(storedInputs);
      const computedDealSizes = {};
      if (useDealInputs && storedInputs) {
        const annualOrders = parseNumberValue(storedInputs.annualOrders);
        const avgLabelCost = parseNumberValue(storedInputs.avgLabelCost);
        const attachRate = parseNumberValue(storedInputs.attachRate);
        const perLabelFee = parseNumberValue(storedInputs.perLabelFee);
        const feeOrderPct = parseNumberValue(storedInputs.feeOrderPct);
        const saasFee = parseNumberValue(storedInputs.saasFee);
        lastPerCarrier.forEach((row) => {
          if (!row || !row.carrier) return;
          const spreadTotals = computeDealSpreadTotalsFromValues({
            annualOrders: Number.isFinite(annualOrders) ? annualOrders : 0,
            avgLabelCost: Number.isFinite(avgLabelCost) ? avgLabelCost : 0,
            commentSold: !!storedInputs.commentSold,
            ebay: !!storedInputs.ebay,
            liveSelling: !!storedInputs.liveSelling,
            attachRate: Number.isFinite(attachRate) ? attachRate : 0,
            selectedCarriers: [row.carrier],
            carrierDetails: dealCarrierDetails
          });
          const labelFeeTotal = (Number.isFinite(perLabelFee) ? perLabelFee : 0)
            * ((Number.isFinite(feeOrderPct) ? feeOrderPct : 0) * (Number.isFinite(annualOrders) ? annualOrders : 0));
          const dealSize = spreadTotals.totalSpread + (Number.isFinite(saasFee) ? saasFee : 0) + labelFeeTotal;
          computedDealSizes[row.carrier] = Number.isFinite(dealSize) ? dealSize : null;
        });
      }
      const maxValues = {};
      columns.forEach(({ key }) => {
        const values = perCarrier
          .map(row => {
            if (key === 'Est. Redo Deal Size' && computedDealSizes[row.carrier] !== undefined) {
              return computedDealSizes[row.carrier];
            }
            return parseMetricValue((row.metrics || {})[key]);
          })
          .filter(val => val !== null);
        maxValues[key] = values.length ? Math.max(...values) : null;
      });
      perCarrier
        .filter(row => !hiddenCarriers.has(row.carrier))
        .forEach((row) => {
        const metrics = row.metrics || {};
        const rowEl = document.createElement('div');
        rowEl.className = 'breakdown-row';
        const formatWithHighlight = (key) => {
          if (annualOrdersMissing && suppressedMetrics.has(key)) {
            return '--';
          }
          let raw = metrics[key];
          if (key === 'Est. Redo Deal Size' && computedDealSizes[row.carrier] !== undefined) {
            raw = computedDealSizes[row.carrier];
          }
          const formatted = key === 'Est. Redo Deal Size' && raw !== null && raw !== undefined
            ? formatCurrency(raw)
            : formatMetric(key, raw);
          const numeric = parseMetricValue(raw);
          const max = maxValues[key];
          const hint = breakdownHints[key] || '';
          const wrap = (value) => {
            if (!hint || value === '--') return value;
            return `<span class="breakdown-hint" tabindex="0" data-hint="${hint}">${value}</span>`;
          };
          if (numeric !== null && max !== null && numeric === max) {
            return wrap(`<span class="metric-pill" data-hint="Highest value in column.">${formatted}</span>`);
          }
          return wrap(formatted);
        };
        rowEl.innerHTML = `
          <div>${row.carrier}</div>
          <div>${formatWithHighlight('Est. Merchant Annual Savings')}</div>
          <div>${formatWithHighlight('Est. Redo Deal Size')}</div>
          <div>${formatWithHighlight('Spread Available')}</div>
          <div>${formatWithHighlight('% Orders We Could Win')}</div>
          <div>${formatWithHighlight('% Orders Won W/ Spread')}</div>
        `;
        container.appendChild(rowEl);
      });
    }

    let currentSelection = [];
    let selectionTimer = null;

    function setLoading(isLoading, message, hideContent) {
      const loadingEl = document.getElementById('dashboard-loading');
      const contentEl = document.getElementById('dashboard-content');
      if (message) {
        const textEl = loadingEl.querySelector('.dashboard-loading-text');
        if (textEl) textEl.textContent = message;
      }
      loadingEl.style.display = isLoading ? 'flex' : 'none';
      contentEl.classList.toggle('is-dimmed', isLoading && !hideContent);
      if (hideContent) {
        contentEl.classList.toggle('is-hidden', isLoading);
      } else {
        contentEl.classList.remove('is-hidden');
      }
    }

    async function loadDashboard(selected = null, initial = false, recalculating = false, refresh = false) {
      if (initial) {
        setLoading(true, 'Loading summary...', true);
      } else if (recalculating) {
        setLoading(true, 'Recalculating...', false);
      }
      const options = selected
        ? {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ selected_carriers: selected })
          }
        : {};
      const refreshParam = refresh ? '?refresh=1' : '';
      const response = await fetch(`/api/dashboard/${jobId}${refreshParam}`, options);
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        setLoading(false, '', false);
        return;
      }
      if (data.pending || data.summary_pending) {
        setLoading(true, 'Computing summary metrics (this may take up to 2 minutes)...', true);
        setTimeout(() => loadDashboard(selected, initial, recalculating, true), 1500);
        return;
      }
      const filteredAvailable = (data.available_carriers || []).filter(carrier => !hiddenCarriers.has(carrier));
      const filteredSelected = (data.selected_carriers || []).filter(carrier => !hiddenCarriers.has(carrier));
      if (!selected && filteredSelected.length !== (data.selected_carriers || []).length) {
        await loadDashboard(filteredSelected, false, true, true);
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.summary_pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.show_usps_market_discount) {
        const pct = Number(data.usps_market_pct_off) * 100;
        uspsPercentOffInput.value = Number.isFinite(pct) ? pct.toFixed(1).replace(/\.0$/, '') : '5';
        uspsDollarOffInput.value = Number.isFinite(Number(data.usps_market_dollar_off))
          ? Number(data.usps_market_dollar_off).toFixed(2).replace(/\.00$/, '')
          : '0';
      }
      currentSelection = filteredSelected;
      carrierPercentages = data.carrier_percentages || {};
      renderSummary(data.overall || {});
      renderCarrierBars(filteredAvailable, currentSelection);
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) {
        breakdownSection.classList.remove('is-hidden');
      }
      setLoading(false, '', false);
    }

    async function loadPerCarrier(refresh = false) {
      const loadingEl = document.getElementById('breakdown-loading');
      const breakdownSection = document.getElementById('breakdown-section');
      if (breakdownSection) breakdownSection.classList.remove('is-hidden');
      loadingEl.style.display = 'block';
      const refreshParam = refresh ? '&refresh=1' : '';
      const response = await fetch(`/api/dashboard/${jobId}?per_carrier=1${refreshParam}`);
      const data = await response.json();
      if (data.error) {
        loadingEl.textContent = 'Unable to load carrier breakdown.';
        return;
      }
      annualOrdersMissing = !!data.annual_orders_missing;
      annualOrdersBanner.classList.toggle('is-hidden', !annualOrdersMissing);
      const showDiscounts = !data.pending && !!data.show_usps_market_discount;
      uspsDiscountRow.classList.toggle('is-hidden', !showDiscounts);
      if (data.per_carrier_total) {
        loadingEl.textContent = `Calculating carrier breakdown ${data.per_carrier_count || 0}/${data.per_carrier_total}...`;
      }
      if (data.per_carrier && data.per_carrier.length) {
        renderBreakdown(data.per_carrier);
      }
      if (data.pending) {
        setTimeout(() => loadPerCarrier(refresh), 900);
        return;
      }
      loadingEl.style.display = 'none';
    }

    document.addEventListener('click', (event) => {
      const chip = event.target.closest('.carrier-chip');
      if (!chip || !chip.dataset.carrier) return;
      if (selectionTimer) clearTimeout(selectionTimer);
      selectionTimer = setTimeout(() => {
        const carriers = Array.from(new Set(
          Array.from(document.querySelectorAll('.carrier-chip'))
            .map(el => el.dataset.carrier)
        ));
        const selected = Array.from(new Set(
          Array.from(document.querySelectorAll('.carrier-chip.is-selected'))
            .map(el => el.dataset.carrier)
        ));
        const target = chip.dataset.carrier;
        const nextSelected = selected.includes(target)
          ? selected.filter(c => c !== target)
          : [...selected, target];
        if (!nextSelected.length) {
          renderCarrierBars(carriers, currentSelection);
          return;
        }
        loadDashboard(nextSelected, false, true, true).then(async () => {
          await loadPerCarrier(true);
          await refreshDealSizeFromStoredInputs();
        });
      }, 200);
    });

    loadDashboard(null, true).then(loadPerCarrier);

    function openAnnualOrdersModal() {
      annualOrdersModal.classList.remove('is-hidden');
      annualOrdersInput.value = '';
      annualOrdersInput.focus();
    }

    function closeAnnualOrdersModal() {
      if (!annualOrdersLoading.classList.contains('is-hidden')) return;
      annualOrdersModal.classList.add('is-hidden');
    }

    async function saveAnnualOrders() {
      const cleaned = String(annualOrdersInput.value || '').replace(/[, ]/g, '');
      if (!cleaned || isNaN(cleaned)) {
        alert('Please enter a valid number');
        return;
      }
      const value = Math.floor(Number(cleaned));
      if (value <= 0) {
        alert('Annual orders must be greater than 0');
        return;
      }
      annualOrdersLoading.classList.remove('is-hidden');
      annualOrdersSave.disabled = true;
      annualOrdersCancel.disabled = true;
      const response = await fetch(`/api/annual-orders/${jobId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ annual_orders: value })
      });
      const data = await response.json();
      annualOrdersLoading.classList.add('is-hidden');
      annualOrdersSave.disabled = false;
      annualOrdersCancel.disabled = false;
      if (data.error) {
        alert(data.error);
        return;
      }
      localStorage.setItem('annual_orders', String(value));
      closeAnnualOrdersModal();
      loadDashboard(currentSelection, false, true).then(loadPerCarrier);
    }

    annualOrdersBtn.addEventListener('click', openAnnualOrdersModal);
    annualOrdersCancel.addEventListener('click', closeAnnualOrdersModal);
    annualOrdersSave.addEventListener('click', saveAnnualOrders);
    annualOrdersModal.addEventListener('click', (event) => {
      if (event.target === annualOrdersModal) {
        closeAnnualOrdersModal();
      }
    });

    function queueDiscountUpdate() {
      if (discountUpdateTimer) clearTimeout(discountUpdateTimer);
      discountUpdateTimer = setTimeout(async () => {
        const pct = parseFloat(uspsPercentOffInput.value || '0');
        const dollar = parseFloat(uspsDollarOffInput.value || '0');
        if (isNaN(pct) || isNaN(dollar)) return;
        setLoading(true, 'Recalculating...', false);
        const response = await fetch(`/api/usps-market-discount/${jobId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            pct_off: pct / 100,
            dollar_off: dollar
          })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
          setLoading(false, '', false);
          return;
        }
        await loadDashboard(currentSelection, false, true, true);
        await loadPerCarrier(true);
        await refreshDealSizeFromStoredInputs();
      }, 450);
    }

    uspsPercentOffInput.addEventListener('input', queueDiscountUpdate);
    uspsDollarOffInput.addEventListener('input', queueDiscountUpdate);

    function formatNumber(value) {
      if (value === null || value === undefined || isNaN(value)) return '--';
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(value);
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return '--';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(value);
    }

    function saasTierForOrders(annualOrders) {
      if (!Number.isFinite(annualOrders) || annualOrders <= 0) {
        return { fee: 0, tier: 'Starter Tier' };
      }
      if (annualOrders < 5000) {
        return { fee: 99, tier: 'Starter Tier' };
      }
      if (annualOrders < 15000) {
        return { fee: 199, tier: 'Growth Tier' };
      }
      if (annualOrders < 35000) {
        return { fee: 299, tier: 'Pro Tier' };
      }
      if (annualOrders < 50000) {
        return { fee: 399, tier: 'Scale Tier' };
      }
      return { fee: 399, tier: 'Enterprise Tier' };
    }

    function normalizeCarrierKey(value) {
      return String(value || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '');
    }

    function buildCarrierDetailMap(details) {
      const map = {};
      (details || []).forEach((detail) => {
        const key = normalizeCarrierKey(detail && detail.carrier);
        if (!key) return;
        map[key] = detail;
      });
      return map;
    }

    function carrierPercent(detail) {
      if (!detail) return 0;
      let pct = Number(detail.orders_won_pct);
      if (!Number.isFinite(pct)) return 0;
      if (pct > 1) pct /= 100;
      return pct;
    }

    function carrierSpreadValue(detail) {
      if (!detail) return null;
      const spread = Number(detail.spread);
      return Number.isFinite(spread) ? spread : null;
    }

    function adjustedOrdersForInputs(annualOrders, commentSold, ebay, liveSelling) {
      let adjusted = annualOrders;
      if (commentSold) adjusted *= 0.6;
      if (ebay) {
        adjusted *= liveSelling ? 0.6 : 0.95;
      }
      return adjusted;
    }

    function computeDealSpreadTotalsFromValues({
      annualOrders,
      avgLabelCost,
      commentSold,
      ebay,
      liveSelling,
      attachRate,
      selectedCarriers,
      carrierDetails
    }) {
      const adjustedOrders = adjustedOrdersForInputs(
        annualOrders,
        commentSold,
        ebay,
        liveSelling
      );
      const attachFactor = Number.isFinite(Number(attachRate)) ? Number(attachRate) / 100 : 1;
      const effectiveOrders = adjustedOrders * attachFactor;
      const avgLabel = Number(avgLabelCost || 0);
      const selectedSet = new Set(selectedCarriers || currentSelection || []);
      const detailMap = buildCarrierDetailMap(carrierDetails || dealCarrierDetails);

      if (effectiveOrders <= 0) {
        return { totalSpread: 0, spreadPerOrder: 0, adjustedOrders };
      }

      let totalSpread = 0;
      if (selectedSet.has('USPS Market')) {
        const pct = carrierPercent(detailMap[normalizeCarrierKey('USPS Market')]);
        totalSpread += 0.2 * pct * effectiveOrders;
      }

      let upsPct = 0;
      if (selectedSet.has('UPS Ground')) {
        upsPct += carrierPercent(detailMap[normalizeCarrierKey('UPS Ground')]);
      }
      if (selectedSet.has('UPS Ground Saver')) {
        upsPct += carrierPercent(detailMap[normalizeCarrierKey('UPS Ground Saver')]);
      }
      if (upsPct > 0 && Number.isFinite(avgLabel)) {
        totalSpread += avgLabel * 0.11 * upsPct * effectiveOrders;
      }

      ['FedEx', 'Amazon', 'UniUni'].forEach((carrier) => {
        if (!selectedSet.has(carrier)) return;
        const detail = detailMap[normalizeCarrierKey(carrier)];
        const pct = carrierPercent(detail);
        const spread = carrierSpreadValue(detail);
        if (!pct || spread === null) return;
        totalSpread += spread * pct * effectiveOrders;
      });

      const spreadPerOrder = adjustedOrders > 0 ? totalSpread / adjustedOrders : 0;
      return { totalSpread, spreadPerOrder, adjustedOrders };
    }

    function computeDealSpreadTotals() {
      const annualOrders = Number(dealAnnualOrders.value || 0);
      return computeDealSpreadTotalsFromValues({
        annualOrders,
        avgLabelCost: Number(dealAvgLabelCost.value || 0),
        commentSold: toggleCommentSold.checked,
        ebay: toggleEbay.checked,
        liveSelling: toggleLiveSelling.checked,
        attachRate: Number(dealAttachRate.value || 0),
        selectedCarriers: currentSelection || [],
        carrierDetails: dealCarrierDetails
      });
    }

    function updateDealSizing() {
      const annualOrders = Number(dealAnnualOrders.value || 0);
      const commentSold = toggleCommentSold.checked;
      const ebay = toggleEbay.checked;
      const liveSelling = toggleLiveSelling.checked;
      const saasTier = saasTierForOrders(annualOrders);
      if (dealSaasTierLabel) {
        dealSaasTierLabel.textContent = saasTier.tier;
      }

      const spreadTotals = computeDealSpreadTotalsFromValues({
        annualOrders,
        avgLabelCost: Number(dealAvgLabelCost.value || 0),
        commentSold,
        ebay,
        liveSelling,
        attachRate: Number(dealAttachRate.value || 0),
        selectedCarriers: currentSelection || [],
        carrierDetails: dealCarrierDetails
      });
      dealAdjustedOrders.textContent = formatNumber(spreadTotals.adjustedOrders || 0);
      if (dealCarrierSpreadLoading) {
        dealCarrierSpreadLoading.classList.toggle('is-hidden', !dealCarrierDetailsPending);
      }
      dealSpreadPerOrder = spreadTotals.spreadPerOrder || 0;
      const carrierSpreadEl = document.getElementById('deal-carrier-spread');
      if (carrierSpreadEl) {
        carrierSpreadEl.textContent = formatCurrency(spreadTotals.totalSpread || 0);
      }
      if (lastPerCarrier.length) {
        renderBreakdown(lastPerCarrier);
      }
    }

    async function refreshDealSizeFromStoredInputs() {
      const stored = getStoredDealInputs();
      if (!stored) return;
      const response = await fetch(`/api/deal-sizing/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_carriers: currentSelection || [] })
      });
      const data = await response.json();
      if (data.error) return;
      if (Array.isArray(data.carrier_details)) {
        dealCarrierDetails = data.carrier_details;
        dealCarrierDetailsPending = !!data.carrier_details_pending;
      }

      const annualOrders = Number(stored.annualOrders || 0);
      const perLabelFee = Number(stored.perLabelFee || 0);
      const feeOrderPct = Number(stored.feeOrderPct || 0);
      const saasFee = Number(stored.saasFee || 0);
      const spreadTotals = computeDealSpreadTotalsFromValues({
        annualOrders,
        avgLabelCost: Number(stored.avgLabelCost || 0),
        commentSold: !!stored.commentSold,
        ebay: !!stored.ebay,
        liveSelling: !!stored.liveSelling,
        attachRate: Number(stored.attachRate || 0),
        selectedCarriers: currentSelection || [],
        carrierDetails: dealCarrierDetails
      });
      const labelFeeTotal = perLabelFee * (feeOrderPct * annualOrders);
      const dealSize = spreadTotals.totalSpread + saasFee + labelFeeTotal;
      const dealValueEl = document.getElementById('metric-redo-deal-size');
      if (dealValueEl) {
        dealValueEl.textContent = formatCurrency(dealSize);
      }
      localStorage.setItem(dealSizeStorageKey, String(Number.isFinite(dealSize) ? dealSize : 0));
      if (dealSizingCard) {
        dealSizingCard.classList.add('has-deal-size');
      }
      if (lastPerCarrier.length) {
        renderBreakdown(lastPerCarrier);
      }
    }

    async function openDealSizing() {
      dealCarrierDetails = [];
      dealCarrierDetailsPending = false;
      const response = await fetch(`/api/deal-sizing/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_carriers: currentSelection || [] })
      });
      const data = await response.json();
      if (data.error) {
        alert(data.error);
        return;
      }
      const stored = getStoredDealInputs();
      const storedInputs = hasUsableDealInputs(stored) ? stored : null;
      const baseAnnualOrders = parseNumberValue(
        data.annual_orders || localStorage.getItem('annual_orders') || 0
      );
      const rawWinRate = Number(currentMetrics['% Orders We Could Win'] || 0) * 100;
      const winRate = Math.max(0, Math.min(100, rawWinRate));
      const avgLabel = Number.isFinite(parseNumberValue(storedInputs && storedInputs.avgLabelCost))
        ? parseNumberValue(storedInputs && storedInputs.avgLabelCost)
        : Number(data.avg_label_cost || 0);
      const annualOrders = Number.isFinite(parseNumberValue(storedInputs && storedInputs.annualOrders))
        ? parseNumberValue(storedInputs && storedInputs.annualOrders)
        : baseAnnualOrders;
      const perLabelFee = Number.isFinite(parseNumberValue(storedInputs && storedInputs.perLabelFee))
        ? parseNumberValue(storedInputs && storedInputs.perLabelFee)
        : 0.00;
      const feeOrderPct = Number.isFinite(parseNumberValue(storedInputs && storedInputs.feeOrderPct))
        ? parseNumberValue(storedInputs && storedInputs.feeOrderPct) * 100
        : Math.max(0, 100 - winRate);
      const attachRate = Number.isFinite(parseNumberValue(storedInputs && storedInputs.attachRate))
        ? parseNumberValue(storedInputs && storedInputs.attachRate)
        : 85;
      const saasFee = Number.isFinite(parseNumberValue(storedInputs && storedInputs.saasFee))
        ? parseNumberValue(storedInputs && storedInputs.saasFee)
        : saasTierForOrders(annualOrders).fee;
      dealCarrierDetails = Array.isArray(data.carrier_details) ? data.carrier_details : [];
      dealCarrierDetailsPending = !!data.carrier_details_pending;

      toggleCommentSold.checked = !!(storedInputs && storedInputs.commentSold);
      toggleEbay.checked = !!(storedInputs && storedInputs.ebay);
      toggleLiveSelling.checked = !!(storedInputs && storedInputs.liveSelling);

      dealAnnualOrders.value = annualOrders ? Math.round(annualOrders) : '';
      dealAvgLabelCost.value = Number.isFinite(avgLabel) ? avgLabel.toFixed(2).replace(/\.00$/, '') : '';
      dealPerLabelFee.value = Number.isFinite(perLabelFee) ? perLabelFee.toFixed(2) : '';
      dealFeeOrderPct.value = Number.isFinite(feeOrderPct)
        ? feeOrderPct.toFixed(1).replace(/\.0$/, '')
        : '';
      dealAttachRate.value = Number.isFinite(attachRate)
        ? attachRate.toFixed(1).replace(/\.0$/, '')
        : '';
      dealSaasFee.value = Number.isFinite(saasFee) ? saasFee.toFixed(0) : '';

      toggleLiveRow.style.display = toggleEbay.checked ? 'flex' : 'none';
      dealAttachUploadField.classList.toggle('is-hidden', attachRate <= 85);
      dealSizingModal.classList.remove('is-hidden');
      updateDealSizing();

      if (data.carrier_details_pending) {
        setTimeout(async () => {
          const refresh = await fetch(`/api/deal-sizing/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected_carriers: currentSelection || [] })
          });
          const refreshed = await refresh.json();
          if (!refreshed.error && Array.isArray(refreshed.carrier_details)) {
            dealCarrierDetails = refreshed.carrier_details;
            dealCarrierDetailsPending = !!refreshed.carrier_details_pending;
            updateDealSizing();
          }
        }, 900);
      }
    }

    dealSizingBtn.addEventListener('click', openDealSizing);
    dealSizingEdit.addEventListener('click', openDealSizing);
    dealSizingClose.addEventListener('click', () => dealSizingModal.classList.add('is-hidden'));
    dealSizingSave.addEventListener('click', () => {
      const attachRate = Number(dealAttachRate.value || 0);
      const requiresUpload = Number.isFinite(attachRate) && attachRate > 85;
      if (requiresUpload && !dealAttachUpload.files.length) {
        alert('Upload a screenshot of Redo Usage Dashboard');
        return;
      }
      const annualOrders = Number(dealAnnualOrders.value || 0);
      const perLabelFee = Number(dealPerLabelFee.value || 0);
      const feeOrderPct = (Number(dealFeeOrderPct.value || 0) || 0) / 100;
      const saasFee = Number(dealSaasFee.value || 0);
      const labelFeeTotal = perLabelFee * (feeOrderPct * annualOrders);
      const spreadTotals = computeDealSpreadTotals();
      const dealSize = spreadTotals.totalSpread + saasFee + labelFeeTotal;
      const dealValueEl = document.getElementById('metric-redo-deal-size');
      if (dealValueEl) {
        dealValueEl.textContent = formatCurrency(dealSize);
      }
      saveDealInputs({
        annualOrders,
        avgLabelCost: Number(dealAvgLabelCost.value || 0),
        perLabelFee,
        feeOrderPct,
        attachRate,
        saasFee,
        commentSold: toggleCommentSold.checked,
        ebay: toggleEbay.checked,
        liveSelling: toggleLiveSelling.checked,
        printing: togglePrinting.checked
      });
      const attachUploadName = dealAttachUpload && dealAttachUpload.files && dealAttachUpload.files.length
        ? dealAttachUpload.files[0].name
        : '';
      fetch(`/api/deal-sizing-inputs/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          annual_orders: annualOrders,
          avg_label_cost: Number(dealAvgLabelCost.value || 0),
          per_label_fee: perLabelFee,
          fee_order_pct: feeOrderPct,
          attach_rate: attachRate,
          saas_fee: saasFee,
          comment_sold: toggleCommentSold.checked,
          ebay: toggleEbay.checked,
          live_selling: toggleLiveSelling.checked,
          printing: togglePrinting.checked,
          selected_carriers: currentSelection || [],
          attach_upload_name: attachUploadName
        })
      }).catch(() => {});
      localStorage.setItem(dealSizeStorageKey, String(Number.isFinite(dealSize) ? dealSize : 0));
      const dealCard = document.querySelector('.metric-card--deal-sizing');
      if (dealCard) dealCard.classList.add('has-deal-size');
      dealSizingModal.classList.add('is-hidden');
    });
    dealSizingModal.addEventListener('click', (event) => {
      if (event.target === dealSizingModal) {
        dealSizingModal.classList.add('is-hidden');
      }
    });

    [dealAnnualOrders, dealAvgLabelCost, dealPerLabelFee, dealFeeOrderPct, dealAttachRate, dealSaasFee].forEach((el) => {
      if (!el) return;
      el.addEventListener('input', updateDealSizing);
    });

    dealFeeOrderPct.addEventListener('input', () => {
      const feePct = Number(dealFeeOrderPct.value || 0);
      dealFeeOrderPct.value = Number.isFinite(feePct)
        ? feePct.toFixed(1).replace(/\.0$/, '')
        : '';
    });

    dealAttachRate.addEventListener('input', () => {
      const rate = Number(dealAttachRate.value || 0);
      const showUpload = Number.isFinite(rate) && rate > 85;
      dealAttachUploadField.classList.toggle('is-hidden', !showUpload);
      dealAttachUpload.required = showUpload;
      if (!showUpload) {
        dealAttachUpload.value = '';
      }
    });

    toggleCommentSold.addEventListener('change', updateDealSizing);
    toggleEbay.addEventListener('change', () => {
      toggleLiveRow.style.display = toggleEbay.checked ? 'flex' : 'none';
      updateDealSizing();
    });
    toggleLiveSelling.addEventListener('change', updateDealSizing);
    togglePrinting.addEventListener('change', updateDealSizing);
  </script>
</body>
</html>
